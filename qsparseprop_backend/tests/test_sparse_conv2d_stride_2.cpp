#include "gtest/gtest.h"
#include "gmock/gmock.h"
#include "src/sparse/qsparse_conv2d_stride_2.h"

#include <iostream>

TEST(Test_Sparse, QuantizeSparseConv2dForward1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        120,    1,   24,  116,   73,  127,  -25,   -6,  -90,  -39,   88,  -60,
        -121, -128, -107,   20, -118,  -43,   63, -116,   96,  -36,  118,   32,
        61,   25,    3,  -74,   13,  -14,  127,  -12,  -93,  -41,    7,   59,
        -40,   93, -115, -110, -124,  -25,  -46,   -4,   -8,  -80,  -10,  -95,
        31,   85,  127,  127,   18,   56,  -87,  -94,   15,   17,  114,  105,
        109, -128,    0,  100,  -79,   23, -124,  -71,   49, -128,  -11,  107,
        11, -100,  117,   89,   15,  127,   77,  -30,  -74,   45,   72,   43,
        54,   36,  -86,  122,  -43,  -10,  -44,   57,   98,  112,  127,  -79,
        -12,  127, -101,  125,    5,  -59,   91, -111,  127,  102,  -65,  127,
        -117,  -32,   72,   83,  -37,  -35,  -87,  127,  -70,   97,   94,  -27,
        -35,  127,   93,  -37,  -28,  -44,  115, -128, -121,  -86,  -45,  -46,
        -74,  101,  127,  116,   31,  127,  -22,   47,  111, -103,  127,  -40,
        -47,  108,   52,  -15,  101,  -61,   62,  -42, -107,   20,   20,   85,
        -128, -110,  127, -124,  -33,  -34,  -83, -118, -126,  -30,   12,  -47,
        23,   34, -105,  123,  127,  127, -107, -123,  -16, -112,   50,   77,
        -41,    8,  127, -124, -128,  -10,  -62,  -32,   98,   -3,  127,  -26,
        116, -128,   35,  -22,  -43,  127,   28,  104,  -13,   46,  109,  -98,
        -127,   -6,  -56,  127,  101,   54,   16,  -10,   26,  -57,    0,   26,
        -51, -114,  -80,  -81,  127, -113,   -4,  -49, -128,  -63,    3,   12,
        127,  -85,   74,   72,   95,  -49,  103,   53,   22,  127,    2,  -35,
        -68,  -29,  -91,  -10,  112,  112,   37,  -47,  -72,   53,   45,  -70,
        73,   12,  127,  -65,   32,  -42,  126,  -32,   98, -110,   44,  117,
        -77, -107, -128,   -1, -122,    8,   75,  -26, -123,   10,  -59,   24,
        -93,   10,   35,   87,   28,   37,   32,   31,  -82, -128,  108,  109,
        -124,  -96,   28,  -95,   71, -104,  127,  -67,  125,  127,  -20,   66,
        77,  -73,   54,   90,   60,   94,  -39,   -9,  -62,   79,   53,   88,
        -128, -128,   15,  -22,  -71,  -37,   37,  -31,   15, -116,    7, -128,
        -96,    4,   -9,  -87,   36,   73, -105, -105, -111,  -80,   27,  -82,
        -11,   37,  -38,  100,  107,   21,  -82,  -30,  -16,  -17,  -50, -115,
        127, -128,   91, -128, -102,  -33,  120,   -2,   53,   -5,   50, -125,
        72,  -68,  127, -128,  127,  -20,  -86, -128, -118,   54,    9,   75,
        24, -125,  -40, -121,   14,   68,   80, -128,  -94,  -87, -115,  -79,
        95,  -23,  -13,  -89,    6,  124,   57,   -9,  -20,  101,   51,  -18,
        -19,   18,  -14,  124,   32,  -38,   29,  110,  -27, -103,  -19, -128,
        -69,   35,  -52,  112, -101,   27,  117,  127,   64,  127,  -68,   49,
        118,  124,   49,  -59,  -71,  -49,   78,  127,  -20,  101,   -2, -118,
        84, -101,   75,    2,   26, -107,  -53,   -9, -128,   10,   71,  -32,
        74,  -83,  127, -128,  104,   86,   81,  -63,  103, -128,  127,   62,
        -65, -104,  -54,   83,  -86, -110, -128,   54, -128,  -97,  -33,  -70,
        -91,  -86, -115,  -75,   13,  -88, -109, -119,  -66,   83, -107,  -49,
        -9,  -50,  -97,  -47,  101, -128,  115,  -96,  -93,  -59,   46,   65,
        -91,   -1,   87, -128,  104, -128,   52, -128,  -38,   73,   94,   26,
        90,   22,  -25,   82,  127,   46,  -11, -128,  -80,   27,  127,  127,
        -90,  -12,  127,   17,   92,    5,  -75,  -74,  -89, -128,   45,   92,
        -44,   45,  127, -124,   52,  -42, -122,  108,    9,   60,  -87,   51,
        52,    7,  -69,   52, -126,   59,   20,  127,   27,  -17,   24,   38,
        36,  111,  127,  -28,  127,  112,  -50, -128,   35,  121, -128,  -55,
        119, -102, -107,   36,  -14,  -58,  -19,  -79,  108, -125,  -12,  -87,
        127,  127, -119,  -97, -104,  105,  -53,   63,  -33,  118,  107,   79,
        65,   -5,  127, -128,  110,  -73,  116,  127,  -56, -128,  -52,  -23,
        -13,  -78,   29,  -10,   83,   14, -127, -119,   55,  -15,  -18,  124,
        12,   61,  -60,   76,  127,  114,  -99,   19,  -78,    1,  -77,  -52,
        127,   23, -128,  -41,   53,  -48,  127,   97,  -19,  -11,   28,   88,
        39,   25,   25,  -26,  -41,  -97, -113,  102,   12, -123,  -30,   76,
        57,  127,  -78,  -52,   90,   96,  -95, -125,  -53,   56,  127, -128,
        -112, -128,  -37,  114,  -68,   40,  -76,   14,   -8,  -53, -127,   89,
        -120,   13,  -60,  -33,  -24,   26,  106,   76,   26,  127,   97,  -93,
        90,   51,  -51,  127,  108,  -34,  -64,  -19,   72,   63, -108,  127,
        -90, -123,  -86,  120,  -16,  -79,  127,  -94,   98,  -61,  -67,  -45,
        -115,   59,  -87,  -21,    1,  125,  -94, -116, -118,  -10,  -68,   74,
        -74,   27,   42,  106,   90,  -98,   49,  -68,    9,   17, -128,  -36,
        108,  -91, -121,   65,   53,  127,  -25,   44,   42,   79,  -91,   29,
        127,  -44,   42,  -28,   44,   83, -113,  -76,  -68,   27, -128,  -17,
        -56,  -21,  -49,  -57, -126,   62,  -73,   47,  -23,  118,  -59, -102,
        11,   20,  -30,  -54,  -41,  -84,   13,  -15,   56,  122,    9,   -6,
        108, -128,   62,   -3, -124,  -46, -114,  -24, -128,   59,   41,   56,
        -8,   30,  -58,  -55,   73,   -2,   20,  -24,   82,   78,  -59,   99,
        59,   19,  127,   75,   89, -128,   99,  107,  110,  -21,  123,  -73,
        18,  127,    0,   97,  103,   -6,  -60,  120,  -30,  -30,   15,  -92,
        -3,  127,  127, -112, -104,  -87, -125, -124,  -62, -118,  -82,   78,
        -93,   61,  109,  -41,   86,  127,   87,   23,  110, -128,  -77,  -83,
        -8, -109,  -14, -114,  -46,  118,  113,   66,  127,   36,  -53,  -73,
        -73,   27,   94,  -79,   31,  -25,  -92, -128, -128,   79,   51, -102,
        -55,  -14,  -45, -108,  -32,   27,  -47,   58,  -56,   42,   20,   84,
        64,    6,  -39,  -47,   71,  -92,   97,   43,   95,  -95,  -56,  -66,
        2,   99,  -52, -124,  -33,  -82,  -72, -107,   86,  106, -101,   78,
        60,  -51,  106,  127,  127,   84,   60,  -20,    9,   14,   43,  127,
        -12,   -1, -128,  -12, -128,   54,  -84, -107,   18,  -33,   55,    5,
        28,  127,   65,  -11, -105,   35,   22,  -72,   52,   82,  -30,  124,
        122,  -59, -128,   19,   97, -128, -109,   18, -105,  125,  -81,   29,
        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34, -128,  -73, -128,  127,   13,   -1,  -50,   74,
        -2, -127,   69,   25,  -44,   72,  113,   80,   49,   -4,  -15,  -95,
        -41,  124,  103,  -69,  -12, -103,    1,  115,  103,  -70,   59, -128,
        -34,  -17,   49,  -37,  -92,  -54,  -81, -106,   96, -128,  -23,  108,
        127, -122,    2,   83,  -33,  -89,  -47,  127, -128, -117,  -84,   -2,
        -128,   84,  -52,   87,  -58,   64,  -80,  -60,   28,   -6,  -58,   78,
        61,   11, -128,   86,   81, -120,  -84,  104,   85,  -16,  -39,  107,
        126,  -79,  -80,  -35,   99,  -80,  121,  127,  106, -119,   95,   61,
        -18,  -10,  100, -116,   99,  -10,    2,  -56,   78,   56,   43, -104,
        81,  -31,  -85,  102,  -82,  123,  115,   12,   -7,  -23, -104,  121,
        9,   -1,    1,  126,  127,  125,  127,   44, -105,  -81,   52,  -86,
        -52,   16,  117, -125,   17, -112,  -48,    4, -109,   16,  -59,   25,
        -82,  106, -128,   43,   48,   83, -126,  -66,  -94,  -83,    5,  100,
        55,  -89,  -95,  -13,  -10,  -31,   62, -100,   88, -123,  127,   71,
        -105,  127,   69,  127, -128,  -31, -105,   53,   83,  124,  -91,   61,
        -100,  -34, -128,    4,   98,  -79,  127,  127, -128,  -81,  127, -114,
        -59,  -79,   73,   49,   31,  -55,  101, -116,  125, -128,    1,  -94,
        -43,  -99,   -6,   19,  -97,  -27, -109, -108, -120,  -35,   50,   56,
        -18,  106,   28,  109,   55, -128,  -13,   66,   43,   89,  127,  127,
        96,  -67,   18,  -74,  -13,  104,  -81,  -13,   -4, -110,   35,  109,
        -96,  113,    8,  -44,    5,   39,  -73,   49,   83,   46,  102,   57,
        109,  114,  -56, -120,  -38,  -88,  -93,   37,  -71,   26,   22,   85,
        127,  127,   67,  127,   -8,  122,   46,    0,  -80,   87, -111,  127,
        -44,   17,    3,  112,  108,  112,  -26,  -60,  -81,  118,  -75, -128,
        -45,  -52,  -87,  -26,  -15,  -50, -128,   93,  126,  127,   31,  -57,
        -17,   21,   87,  102,  112, -127, -118,  125,  -40,  127,   57,    4,
        -83, -111, -112,  -88,   62,  -78, -128,   54,  -75,   84,  -21,   72,
        127,  -35,  -73, -117,  127,   69,   50,  -80,   81, -114, -128,   92,
        -107, -108,  105,   -4,  -54,   57,  -49,  127,  -82,  127,  -80,   43,
        63,   24,   23,  -23,   57,  -77,   42,  127, -128,   30,   13,  -41,
        -65,  -67,   18, -128, -128,   92,   64,  -77,   58,  101, -108,   36,
        55, -121,   54,   91,  -13,   24,   66,   50, -128,  -86, -128,   40,
        127,  127, -128,  -32,  -25, -113,  125,   14,  -15, -101,  -20,  -38,
        -31,   65,  -68, -119,  -76,   -4,  -73,   52,   87,   19,   30,   48,
        118,  109,   51,  -43,  -81,  -71,   20,  108,   10, -102, -128,   -4,
        -80,   38, -128,  -84,   43,  127,   21,  -16,  127,  -16,   33,  108,
        -114,   69,   52,  127,  -60, -124, -128,  -73,  127,  127,  116,  -68,
        -78,  -68,   41,   85,  -84,  113,   53,  -89,   59,  -95,  -48,    2,
        76, -106,  -59,   23,   31,  -32,  -43,  -67, -128,  -40,  -14,  127,
        41,  -91,  -59,  127,   35,   71,  -84, -128,  127,   93,  127,   40,
        -125,   77,  127, -128,  127,  -63, -125,  -86,  -93, -117,  125,   72,
        -4,  -53,  127, -106,   -8,  127, -106,  127, -108,  -47,   37,   97,
        127,  127,  -30,   71,   25,   44,  -34,  -71,   72,  125,   18,  127
    };
    float X_scale = 0.0068;
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale = 0.0164;
    float O[384];
    for (int i = 0; i < 384; i++) {
        O[i] = 0.0f;
    }
    float expected_O[384] = {
        -0.32751, -0.860379, 0.134698, -1.51122, -0.686316, -0.794174, 0.0456554, -0.710866,
        0.513953, 0.451265, -1.04393, -0.405387, -0.412326, -0.0451973, 0.406947, -0.81619,
        0.184438, 0.348267, -0.40773, 1.22317, 0.272505, 0.475616, -0.955179, -0.123118, -0.250479,
        -0.448769, -0.358889, -0.328313, 0.871675, -0.648493, 0.325087, -0.61935,
        -0.114082, -0.173579, 0.782683, -0.386986, 0.479132, -0.21721, 0.635533, -0.398349,
        0.961082, -0.547002, 1.07752, -0.672141, 0.72637, 0.404673, -0.505057, -0.54519,
        -0.882915, 0.0807834, -0.611832, -0.000362335, 0.236161, -0.95259, 0.277764, -0.303415,
        0.23266, 0.583722, -0.0424994, -1.50855, -1.12271, -0.213993, -0.920017, -0.844027,
        -0.479779, -0.388866, -0.166552, -0.211928, -0.281142, 0.423207, 0.54662, 0.487937,
        0.127642, 0.63223, -0.032759, 0.250923, 0.453613, -0.404463, 0.56085, -0.234346,
        -0.267176, 0.529325, 0.254168, -0.121234, 0.404612, -0.28319, 0.32044, -0.22726,
        -0.41468, 0.103772, 0.100662, 0.424448, -0.70226, -0.486457, 0.560101, -0.532022,
        -0.202998, -0.200795, -0.32097, -0.561242, -0.57707, -0.126074, -0.00623055, -0.194739,
        0.0756797, 0.207852, -0.484259, 0.539414, 0.584813, 0.70423, -0.512302, -0.541568,
        -0.0589088, -0.531225, 0.229951, 0.372922, -0.196719, 0.103608, 0.667556, -0.500211,
        -0.531643, -0.0282003, -0.28755, -0.0991532, 0.37283, -0.0384498, 0.626721, -0.0996101,
        0.715836, 0.336983, 0.845109, -0.00664388, 0.209212, -0.0920555, 0.859445, -0.0732012,
        -0.343603, -0.0544728, -0.894128, -0.0348023, -0.396101, -1.25667, -0.858363, 0.501175,
        -0.289538, -0.763826, -0.499975, -0.409396, -0.574964, -0.555887, -0.297915, -0.797998, 0.104374, -0.425556, -0.381074, -0.912793, -0.599471, -0.0678525, -1.06442, 0.0349895,
        0.124207, -0.726707, -0.170409, -0.68783, 0.50367, -0.443274, 0.316848, -0.0475457,
        -0.967834, -0.828863, 0.52571, -0.226864, 0.11864, 0.0209037, 0.200918, -1.03906, 0.637762, -0.433581, 0.606689, -1.25304, 0.130528, -0.177622, -0.0268916, 0.129266, 0.500518, -0.504546, -0.488596, 0.467866, 0.884753, 0.464907, -0.622268, -0.208384,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0
    };

    sparse::quantized_sparse_conv2d_vectorized_forward_stride_2(
        B, IC, OC, M, N, K, 8, 0,
        X, X_scale, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, O
    );

    for (int i = 0; i < 384; i++) {
        ASSERT_THAT(O[i], testing::FloatNear(expected_O[i], 0.1f));
    }
}

TEST(Test_Sparse, QuantizeSparseConv2dForwardParallel1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        120,    1,   24,  116,   73,  127,  -25,   -6,  -90,  -39,   88,  -60,
        -121, -128, -107,   20, -118,  -43,   63, -116,   96,  -36,  118,   32,
        61,   25,    3,  -74,   13,  -14,  127,  -12,  -93,  -41,    7,   59,
        -40,   93, -115, -110, -124,  -25,  -46,   -4,   -8,  -80,  -10,  -95,
        31,   85,  127,  127,   18,   56,  -87,  -94,   15,   17,  114,  105,
        109, -128,    0,  100,  -79,   23, -124,  -71,   49, -128,  -11,  107,
        11, -100,  117,   89,   15,  127,   77,  -30,  -74,   45,   72,   43,
        54,   36,  -86,  122,  -43,  -10,  -44,   57,   98,  112,  127,  -79,
        -12,  127, -101,  125,    5,  -59,   91, -111,  127,  102,  -65,  127,
        -117,  -32,   72,   83,  -37,  -35,  -87,  127,  -70,   97,   94,  -27,
        -35,  127,   93,  -37,  -28,  -44,  115, -128, -121,  -86,  -45,  -46,
        -74,  101,  127,  116,   31,  127,  -22,   47,  111, -103,  127,  -40,
        -47,  108,   52,  -15,  101,  -61,   62,  -42, -107,   20,   20,   85,
        -128, -110,  127, -124,  -33,  -34,  -83, -118, -126,  -30,   12,  -47,
        23,   34, -105,  123,  127,  127, -107, -123,  -16, -112,   50,   77,
        -41,    8,  127, -124, -128,  -10,  -62,  -32,   98,   -3,  127,  -26,
        116, -128,   35,  -22,  -43,  127,   28,  104,  -13,   46,  109,  -98,
        -127,   -6,  -56,  127,  101,   54,   16,  -10,   26,  -57,    0,   26,
        -51, -114,  -80,  -81,  127, -113,   -4,  -49, -128,  -63,    3,   12,
        127,  -85,   74,   72,   95,  -49,  103,   53,   22,  127,    2,  -35,
        -68,  -29,  -91,  -10,  112,  112,   37,  -47,  -72,   53,   45,  -70,
        73,   12,  127,  -65,   32,  -42,  126,  -32,   98, -110,   44,  117,
        -77, -107, -128,   -1, -122,    8,   75,  -26, -123,   10,  -59,   24,
        -93,   10,   35,   87,   28,   37,   32,   31,  -82, -128,  108,  109,
        -124,  -96,   28,  -95,   71, -104,  127,  -67,  125,  127,  -20,   66,
        77,  -73,   54,   90,   60,   94,  -39,   -9,  -62,   79,   53,   88,
        -128, -128,   15,  -22,  -71,  -37,   37,  -31,   15, -116,    7, -128,
        -96,    4,   -9,  -87,   36,   73, -105, -105, -111,  -80,   27,  -82,
        -11,   37,  -38,  100,  107,   21,  -82,  -30,  -16,  -17,  -50, -115,
        127, -128,   91, -128, -102,  -33,  120,   -2,   53,   -5,   50, -125,
        72,  -68,  127, -128,  127,  -20,  -86, -128, -118,   54,    9,   75,
        24, -125,  -40, -121,   14,   68,   80, -128,  -94,  -87, -115,  -79,
        95,  -23,  -13,  -89,    6,  124,   57,   -9,  -20,  101,   51,  -18,
        -19,   18,  -14,  124,   32,  -38,   29,  110,  -27, -103,  -19, -128,
        -69,   35,  -52,  112, -101,   27,  117,  127,   64,  127,  -68,   49,
        118,  124,   49,  -59,  -71,  -49,   78,  127,  -20,  101,   -2, -118,
        84, -101,   75,    2,   26, -107,  -53,   -9, -128,   10,   71,  -32,
        74,  -83,  127, -128,  104,   86,   81,  -63,  103, -128,  127,   62,
        -65, -104,  -54,   83,  -86, -110, -128,   54, -128,  -97,  -33,  -70,
        -91,  -86, -115,  -75,   13,  -88, -109, -119,  -66,   83, -107,  -49,
        -9,  -50,  -97,  -47,  101, -128,  115,  -96,  -93,  -59,   46,   65,
        -91,   -1,   87, -128,  104, -128,   52, -128,  -38,   73,   94,   26,
        90,   22,  -25,   82,  127,   46,  -11, -128,  -80,   27,  127,  127,
        -90,  -12,  127,   17,   92,    5,  -75,  -74,  -89, -128,   45,   92,
        -44,   45,  127, -124,   52,  -42, -122,  108,    9,   60,  -87,   51,
        52,    7,  -69,   52, -126,   59,   20,  127,   27,  -17,   24,   38,
        36,  111,  127,  -28,  127,  112,  -50, -128,   35,  121, -128,  -55,
        119, -102, -107,   36,  -14,  -58,  -19,  -79,  108, -125,  -12,  -87,
        127,  127, -119,  -97, -104,  105,  -53,   63,  -33,  118,  107,   79,
        65,   -5,  127, -128,  110,  -73,  116,  127,  -56, -128,  -52,  -23,
        -13,  -78,   29,  -10,   83,   14, -127, -119,   55,  -15,  -18,  124,
        12,   61,  -60,   76,  127,  114,  -99,   19,  -78,    1,  -77,  -52,
        127,   23, -128,  -41,   53,  -48,  127,   97,  -19,  -11,   28,   88,
        39,   25,   25,  -26,  -41,  -97, -113,  102,   12, -123,  -30,   76,
        57,  127,  -78,  -52,   90,   96,  -95, -125,  -53,   56,  127, -128,
        -112, -128,  -37,  114,  -68,   40,  -76,   14,   -8,  -53, -127,   89,
        -120,   13,  -60,  -33,  -24,   26,  106,   76,   26,  127,   97,  -93,
        90,   51,  -51,  127,  108,  -34,  -64,  -19,   72,   63, -108,  127,
        -90, -123,  -86,  120,  -16,  -79,  127,  -94,   98,  -61,  -67,  -45,
        -115,   59,  -87,  -21,    1,  125,  -94, -116, -118,  -10,  -68,   74,
        -74,   27,   42,  106,   90,  -98,   49,  -68,    9,   17, -128,  -36,
        108,  -91, -121,   65,   53,  127,  -25,   44,   42,   79,  -91,   29,
        127,  -44,   42,  -28,   44,   83, -113,  -76,  -68,   27, -128,  -17,
        -56,  -21,  -49,  -57, -126,   62,  -73,   47,  -23,  118,  -59, -102,
        11,   20,  -30,  -54,  -41,  -84,   13,  -15,   56,  122,    9,   -6,
        108, -128,   62,   -3, -124,  -46, -114,  -24, -128,   59,   41,   56,
        -8,   30,  -58,  -55,   73,   -2,   20,  -24,   82,   78,  -59,   99,
        59,   19,  127,   75,   89, -128,   99,  107,  110,  -21,  123,  -73,
        18,  127,    0,   97,  103,   -6,  -60,  120,  -30,  -30,   15,  -92,
        -3,  127,  127, -112, -104,  -87, -125, -124,  -62, -118,  -82,   78,
        -93,   61,  109,  -41,   86,  127,   87,   23,  110, -128,  -77,  -83,
        -8, -109,  -14, -114,  -46,  118,  113,   66,  127,   36,  -53,  -73,
        -73,   27,   94,  -79,   31,  -25,  -92, -128, -128,   79,   51, -102,
        -55,  -14,  -45, -108,  -32,   27,  -47,   58,  -56,   42,   20,   84,
        64,    6,  -39,  -47,   71,  -92,   97,   43,   95,  -95,  -56,  -66,
        2,   99,  -52, -124,  -33,  -82,  -72, -107,   86,  106, -101,   78,
        60,  -51,  106,  127,  127,   84,   60,  -20,    9,   14,   43,  127,
        -12,   -1, -128,  -12, -128,   54,  -84, -107,   18,  -33,   55,    5,
        28,  127,   65,  -11, -105,   35,   22,  -72,   52,   82,  -30,  124,
        122,  -59, -128,   19,   97, -128, -109,   18, -105,  125,  -81,   29,
        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34, -128,  -73, -128,  127,   13,   -1,  -50,   74,
        -2, -127,   69,   25,  -44,   72,  113,   80,   49,   -4,  -15,  -95,
        -41,  124,  103,  -69,  -12, -103,    1,  115,  103,  -70,   59, -128,
        -34,  -17,   49,  -37,  -92,  -54,  -81, -106,   96, -128,  -23,  108,
        127, -122,    2,   83,  -33,  -89,  -47,  127, -128, -117,  -84,   -2,
        -128,   84,  -52,   87,  -58,   64,  -80,  -60,   28,   -6,  -58,   78,
        61,   11, -128,   86,   81, -120,  -84,  104,   85,  -16,  -39,  107,
        126,  -79,  -80,  -35,   99,  -80,  121,  127,  106, -119,   95,   61,
        -18,  -10,  100, -116,   99,  -10,    2,  -56,   78,   56,   43, -104,
        81,  -31,  -85,  102,  -82,  123,  115,   12,   -7,  -23, -104,  121,
        9,   -1,    1,  126,  127,  125,  127,   44, -105,  -81,   52,  -86,
        -52,   16,  117, -125,   17, -112,  -48,    4, -109,   16,  -59,   25,
        -82,  106, -128,   43,   48,   83, -126,  -66,  -94,  -83,    5,  100,
        55,  -89,  -95,  -13,  -10,  -31,   62, -100,   88, -123,  127,   71,
        -105,  127,   69,  127, -128,  -31, -105,   53,   83,  124,  -91,   61,
        -100,  -34, -128,    4,   98,  -79,  127,  127, -128,  -81,  127, -114,
        -59,  -79,   73,   49,   31,  -55,  101, -116,  125, -128,    1,  -94,
        -43,  -99,   -6,   19,  -97,  -27, -109, -108, -120,  -35,   50,   56,
        -18,  106,   28,  109,   55, -128,  -13,   66,   43,   89,  127,  127,
        96,  -67,   18,  -74,  -13,  104,  -81,  -13,   -4, -110,   35,  109,
        -96,  113,    8,  -44,    5,   39,  -73,   49,   83,   46,  102,   57,
        109,  114,  -56, -120,  -38,  -88,  -93,   37,  -71,   26,   22,   85,
        127,  127,   67,  127,   -8,  122,   46,    0,  -80,   87, -111,  127,
        -44,   17,    3,  112,  108,  112,  -26,  -60,  -81,  118,  -75, -128,
        -45,  -52,  -87,  -26,  -15,  -50, -128,   93,  126,  127,   31,  -57,
        -17,   21,   87,  102,  112, -127, -118,  125,  -40,  127,   57,    4,
        -83, -111, -112,  -88,   62,  -78, -128,   54,  -75,   84,  -21,   72,
        127,  -35,  -73, -117,  127,   69,   50,  -80,   81, -114, -128,   92,
        -107, -108,  105,   -4,  -54,   57,  -49,  127,  -82,  127,  -80,   43,
        63,   24,   23,  -23,   57,  -77,   42,  127, -128,   30,   13,  -41,
        -65,  -67,   18, -128, -128,   92,   64,  -77,   58,  101, -108,   36,
        55, -121,   54,   91,  -13,   24,   66,   50, -128,  -86, -128,   40,
        127,  127, -128,  -32,  -25, -113,  125,   14,  -15, -101,  -20,  -38,
        -31,   65,  -68, -119,  -76,   -4,  -73,   52,   87,   19,   30,   48,
        118,  109,   51,  -43,  -81,  -71,   20,  108,   10, -102, -128,   -4,
        -80,   38, -128,  -84,   43,  127,   21,  -16,  127,  -16,   33,  108,
        -114,   69,   52,  127,  -60, -124, -128,  -73,  127,  127,  116,  -68,
        -78,  -68,   41,   85,  -84,  113,   53,  -89,   59,  -95,  -48,    2,
        76, -106,  -59,   23,   31,  -32,  -43,  -67, -128,  -40,  -14,  127,
        41,  -91,  -59,  127,   35,   71,  -84, -128,  127,   93,  127,   40,
        -125,   77,  127, -128,  127,  -63, -125,  -86,  -93, -117,  125,   72,
        -4,  -53,  127, -106,   -8,  127, -106,  127, -108,  -47,   37,   97,
        127,  127,  -30,   71,   25,   44,  -34,  -71,   72,  125,   18,  127
    };
    float X_scale = 0.0068;
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale = 0.0164;
    float O[384];
    for (int i = 0; i < 384; i++) {
        O[i] = 0.0f;
    }
    float expected_O[384] = {
        -0.32751, -0.860379, 0.134698, -1.51122, -0.686316, -0.794174, 0.0456554, -0.710866,
        0.513953, 0.451265, -1.04393, -0.405387, -0.412326, -0.0451973, 0.406947, -0.81619,
        0.184438, 0.348267, -0.40773, 1.22317, 0.272505, 0.475616, -0.955179, -0.123118, -0.250479,
        -0.448769, -0.358889, -0.328313, 0.871675, -0.648493, 0.325087, -0.61935,
        -0.114082, -0.173579, 0.782683, -0.386986, 0.479132, -0.21721, 0.635533, -0.398349,
        0.961082, -0.547002, 1.07752, -0.672141, 0.72637, 0.404673, -0.505057, -0.54519,
        -0.882915, 0.0807834, -0.611832, -0.000362335, 0.236161, -0.95259, 0.277764, -0.303415,
        0.23266, 0.583722, -0.0424994, -1.50855, -1.12271, -0.213993, -0.920017, -0.844027,
        -0.479779, -0.388866, -0.166552, -0.211928, -0.281142, 0.423207, 0.54662, 0.487937,
        0.127642, 0.63223, -0.032759, 0.250923, 0.453613, -0.404463, 0.56085, -0.234346,
        -0.267176, 0.529325, 0.254168, -0.121234, 0.404612, -0.28319, 0.32044, -0.22726,
        -0.41468, 0.103772, 0.100662, 0.424448, -0.70226, -0.486457, 0.560101, -0.532022,
        -0.202998, -0.200795, -0.32097, -0.561242, -0.57707, -0.126074, -0.00623055, -0.194739,
        0.0756797, 0.207852, -0.484259, 0.539414, 0.584813, 0.70423, -0.512302, -0.541568,
        -0.0589088, -0.531225, 0.229951, 0.372922, -0.196719, 0.103608, 0.667556, -0.500211,
        -0.531643, -0.0282003, -0.28755, -0.0991532, 0.37283, -0.0384498, 0.626721, -0.0996101,
        0.715836, 0.336983, 0.845109, -0.00664388, 0.209212, -0.0920555, 0.859445, -0.0732012,
        -0.343603, -0.0544728, -0.894128, -0.0348023, -0.396101, -1.25667, -0.858363, 0.501175,
        -0.289538, -0.763826, -0.499975, -0.409396, -0.574964, -0.555887, -0.297915, -0.797998, 0.104374, -0.425556, -0.381074, -0.912793, -0.599471, -0.0678525, -1.06442, 0.0349895,
        0.124207, -0.726707, -0.170409, -0.68783, 0.50367, -0.443274, 0.316848, -0.0475457,
        -0.967834, -0.828863, 0.52571, -0.226864, 0.11864, 0.0209037, 0.200918, -1.03906, 0.637762, -0.433581, 0.606689, -1.25304, 0.130528, -0.177622, -0.0268916, 0.129266, 0.500518, -0.504546, -0.488596, 0.467866, 0.884753, 0.464907, -0.622268, -0.208384,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0
    };

    sparse::quantized_sparse_conv2d_vectorized_parallel_forward_stride_2(
        B, IC, OC, M, N, K, 8, 0,
        X, X_scale, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, O
    );

    for (int i = 0; i < 384; i++) {
        ASSERT_THAT(O[i], testing::FloatNear(expected_O[i], 0.1f));
    }
}

TEST(Test_Sparse, QuantizeSparseConv2dBackward1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        120,    1,   24,  116,   73,  127,  -25,   -6,  -90,  -39,   88,  -60,
        -121, -128, -107,   20, -118,  -43,   63, -116,   96,  -36,  118,   32,
        61,   25,    3,  -74,   13,  -14,  127,  -12,  -93,  -41,    7,   59,
        -40,   93, -115, -110, -124,  -25,  -46,   -4,   -8,  -80,  -10,  -95,
        31,   85,  127,  127,   18,   56,  -87,  -94,   15,   17,  114,  105,
        109, -128,    0,  100,  -79,   23, -124,  -71,   49, -128,  -11,  107,
        11, -100,  117,   89,   15,  127,   77,  -30,  -74,   45,   72,   43,
        54,   36,  -86,  122,  -43,  -10,  -44,   57,   98,  112,  127,  -79,
        -12,  127, -101,  125,    5,  -59,   91, -111,  127,  102,  -65,  127,
        -117,  -32,   72,   83,  -37,  -35,  -87,  127,  -70,   97,   94,  -27,
        -35,  127,   93,  -37,  -28,  -44,  115, -128, -121,  -86,  -45,  -46,
        -74,  101,  127,  116,   31,  127,  -22,   47,  111, -103,  127,  -40,
        -47,  108,   52,  -15,  101,  -61,   62,  -42, -107,   20,   20,   85,
        -128, -110,  127, -124,  -33,  -34,  -83, -118, -126,  -30,   12,  -47,
        23,   34, -105,  123,  127,  127, -107, -123,  -16, -112,   50,   77,
        -41,    8,  127, -124, -128,  -10,  -62,  -32,   98,   -3,  127,  -26,
        116, -128,   35,  -22,  -43,  127,   28,  104,  -13,   46,  109,  -98,
        -127,   -6,  -56,  127,  101,   54,   16,  -10,   26,  -57,    0,   26,
        -51, -114,  -80,  -81,  127, -113,   -4,  -49, -128,  -63,    3,   12,
        127,  -85,   74,   72,   95,  -49,  103,   53,   22,  127,    2,  -35,
        -68,  -29,  -91,  -10,  112,  112,   37,  -47,  -72,   53,   45,  -70,
        73,   12,  127,  -65,   32,  -42,  126,  -32,   98, -110,   44,  117,
        -77, -107, -128,   -1, -122,    8,   75,  -26, -123,   10,  -59,   24,
        -93,   10,   35,   87,   28,   37,   32,   31,  -82, -128,  108,  109,
        -124,  -96,   28,  -95,   71, -104,  127,  -67,  125,  127,  -20,   66,
        77,  -73,   54,   90,   60,   94,  -39,   -9,  -62,   79,   53,   88,
        -128, -128,   15,  -22,  -71,  -37,   37,  -31,   15, -116,    7, -128,
        -96,    4,   -9,  -87,   36,   73, -105, -105, -111,  -80,   27,  -82,
        -11,   37,  -38,  100,  107,   21,  -82,  -30,  -16,  -17,  -50, -115,
        127, -128,   91, -128, -102,  -33,  120,   -2,   53,   -5,   50, -125,
        72,  -68,  127, -128,  127,  -20,  -86, -128, -118,   54,    9,   75,
        24, -125,  -40, -121,   14,   68,   80, -128,  -94,  -87, -115,  -79,
        95,  -23,  -13,  -89,    6,  124,   57,   -9,  -20,  101,   51,  -18,
        -19,   18,  -14,  124,   32,  -38,   29,  110,  -27, -103,  -19, -128,
        -69,   35,  -52,  112, -101,   27,  117,  127,   64,  127,  -68,   49,
        118,  124,   49,  -59,  -71,  -49,   78,  127,  -20,  101,   -2, -118,
        84, -101,   75,    2,   26, -107,  -53,   -9, -128,   10,   71,  -32,
        74,  -83,  127, -128,  104,   86,   81,  -63,  103, -128,  127,   62,
        -65, -104,  -54,   83,  -86, -110, -128,   54, -128,  -97,  -33,  -70,
        -91,  -86, -115,  -75,   13,  -88, -109, -119,  -66,   83, -107,  -49,
        -9,  -50,  -97,  -47,  101, -128,  115,  -96,  -93,  -59,   46,   65,
        -91,   -1,   87, -128,  104, -128,   52, -128,  -38,   73,   94,   26,
        90,   22,  -25,   82,  127,   46,  -11, -128,  -80,   27,  127,  127,
        -90,  -12,  127,   17,   92,    5,  -75,  -74,  -89, -128,   45,   92,
        -44,   45,  127, -124,   52,  -42, -122,  108,    9,   60,  -87,   51,
        52,    7,  -69,   52, -126,   59,   20,  127,   27,  -17,   24,   38,
        36,  111,  127,  -28,  127,  112,  -50, -128,   35,  121, -128,  -55,
        119, -102, -107,   36,  -14,  -58,  -19,  -79,  108, -125,  -12,  -87,
        127,  127, -119,  -97, -104,  105,  -53,   63,  -33,  118,  107,   79,
        65,   -5,  127, -128,  110,  -73,  116,  127,  -56, -128,  -52,  -23,
        -13,  -78,   29,  -10,   83,   14, -127, -119,   55,  -15,  -18,  124,
        12,   61,  -60,   76,  127,  114,  -99,   19,  -78,    1,  -77,  -52,
        127,   23, -128,  -41,   53,  -48,  127,   97,  -19,  -11,   28,   88,
        39,   25,   25,  -26,  -41,  -97, -113,  102,   12, -123,  -30,   76,
        57,  127,  -78,  -52,   90,   96,  -95, -125,  -53,   56,  127, -128,
        -112, -128,  -37,  114,  -68,   40,  -76,   14,   -8,  -53, -127,   89,
        -120,   13,  -60,  -33,  -24,   26,  106,   76,   26,  127,   97,  -93,
        90,   51,  -51,  127,  108,  -34,  -64,  -19,   72,   63, -108,  127,
        -90, -123,  -86,  120,  -16,  -79,  127,  -94,   98,  -61,  -67,  -45,
        -115,   59,  -87,  -21,    1,  125,  -94, -116, -118,  -10,  -68,   74,
        -74,   27,   42,  106,   90,  -98,   49,  -68,    9,   17, -128,  -36,
        108,  -91, -121,   65,   53,  127,  -25,   44,   42,   79,  -91,   29,
        127,  -44,   42,  -28,   44,   83, -113,  -76,  -68,   27, -128,  -17,
        -56,  -21,  -49,  -57, -126,   62,  -73,   47,  -23,  118,  -59, -102,
        11,   20,  -30,  -54,  -41,  -84,   13,  -15,   56,  122,    9,   -6,
        108, -128,   62,   -3, -124,  -46, -114,  -24, -128,   59,   41,   56,
        -8,   30,  -58,  -55,   73,   -2,   20,  -24,   82,   78,  -59,   99,
        59,   19,  127,   75,   89, -128,   99,  107,  110,  -21,  123,  -73,
        18,  127,    0,   97,  103,   -6,  -60,  120,  -30,  -30,   15,  -92,
        -3,  127,  127, -112, -104,  -87, -125, -124,  -62, -118,  -82,   78,
        -93,   61,  109,  -41,   86,  127,   87,   23,  110, -128,  -77,  -83,
        -8, -109,  -14, -114,  -46,  118,  113,   66,  127,   36,  -53,  -73,
        -73,   27,   94,  -79,   31,  -25,  -92, -128, -128,   79,   51, -102,
        -55,  -14,  -45, -108,  -32,   27,  -47,   58,  -56,   42,   20,   84,
        64,    6,  -39,  -47,   71,  -92,   97,   43,   95,  -95,  -56,  -66,
        2,   99,  -52, -124,  -33,  -82,  -72, -107,   86,  106, -101,   78,
        60,  -51,  106,  127,  127,   84,   60,  -20,    9,   14,   43,  127,
        -12,   -1, -128,  -12, -128,   54,  -84, -107,   18,  -33,   55,    5,
        28,  127,   65,  -11, -105,   35,   22,  -72,   52,   82,  -30,  124,
        122,  -59, -128,   19,   97, -128, -109,   18, -105,  125,  -81,   29,
        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34, -128,  -73, -128,  127,   13,   -1,  -50,   74,
        -2, -127,   69,   25,  -44,   72,  113,   80,   49,   -4,  -15,  -95,
        -41,  124,  103,  -69,  -12, -103,    1,  115,  103,  -70,   59, -128,
        -34,  -17,   49,  -37,  -92,  -54,  -81, -106,   96, -128,  -23,  108,
        127, -122,    2,   83,  -33,  -89,  -47,  127, -128, -117,  -84,   -2,
        -128,   84,  -52,   87,  -58,   64,  -80,  -60,   28,   -6,  -58,   78,
        61,   11, -128,   86,   81, -120,  -84,  104,   85,  -16,  -39,  107,
        126,  -79,  -80,  -35,   99,  -80,  121,  127,  106, -119,   95,   61,
        -18,  -10,  100, -116,   99,  -10,    2,  -56,   78,   56,   43, -104,
        81,  -31,  -85,  102,  -82,  123,  115,   12,   -7,  -23, -104,  121,
        9,   -1,    1,  126,  127,  125,  127,   44, -105,  -81,   52,  -86,
        -52,   16,  117, -125,   17, -112,  -48,    4, -109,   16,  -59,   25,
        -82,  106, -128,   43,   48,   83, -126,  -66,  -94,  -83,    5,  100,
        55,  -89,  -95,  -13,  -10,  -31,   62, -100,   88, -123,  127,   71,
        -105,  127,   69,  127, -128,  -31, -105,   53,   83,  124,  -91,   61,
        -100,  -34, -128,    4,   98,  -79,  127,  127, -128,  -81,  127, -114,
        -59,  -79,   73,   49,   31,  -55,  101, -116,  125, -128,    1,  -94,
        -43,  -99,   -6,   19,  -97,  -27, -109, -108, -120,  -35,   50,   56,
        -18,  106,   28,  109,   55, -128,  -13,   66,   43,   89,  127,  127,
        96,  -67,   18,  -74,  -13,  104,  -81,  -13,   -4, -110,   35,  109,
        -96,  113,    8,  -44,    5,   39,  -73,   49,   83,   46,  102,   57,
        109,  114,  -56, -120,  -38,  -88,  -93,   37,  -71,   26,   22,   85,
        127,  127,   67,  127,   -8,  122,   46,    0,  -80,   87, -111,  127,
        -44,   17,    3,  112,  108,  112,  -26,  -60,  -81,  118,  -75, -128,
        -45,  -52,  -87,  -26,  -15,  -50, -128,   93,  126,  127,   31,  -57,
        -17,   21,   87,  102,  112, -127, -118,  125,  -40,  127,   57,    4,
        -83, -111, -112,  -88,   62,  -78, -128,   54,  -75,   84,  -21,   72,
        127,  -35,  -73, -117,  127,   69,   50,  -80,   81, -114, -128,   92,
        -107, -108,  105,   -4,  -54,   57,  -49,  127,  -82,  127,  -80,   43,
        63,   24,   23,  -23,   57,  -77,   42,  127, -128,   30,   13,  -41,
        -65,  -67,   18, -128, -128,   92,   64,  -77,   58,  101, -108,   36,
        55, -121,   54,   91,  -13,   24,   66,   50, -128,  -86, -128,   40,
        127,  127, -128,  -32,  -25, -113,  125,   14,  -15, -101,  -20,  -38,
        -31,   65,  -68, -119,  -76,   -4,  -73,   52,   87,   19,   30,   48,
        118,  109,   51,  -43,  -81,  -71,   20,  108,   10, -102, -128,   -4,
        -80,   38, -128,  -84,   43,  127,   21,  -16,  127,  -16,   33,  108,
        -114,   69,   52,  127,  -60, -124, -128,  -73,  127,  127,  116,  -68,
        -78,  -68,   41,   85,  -84,  113,   53,  -89,   59,  -95,  -48,    2,
        76, -106,  -59,   23,   31,  -32,  -43,  -67, -128,  -40,  -14,  127,
        41,  -91,  -59,  127,   35,   71,  -84, -128,  127,   93,  127,   40,
        -125,   77,  127, -128,  127,  -63, -125,  -86,  -93, -117,  125,   72,
        -4,  -53,  127, -106,   -8,  127, -106,  127, -108,  -47,   37,   97,
        127,  127,  -30,   71,   25,   44,  -34,  -71,   72,  125,   18,  127
    };
    float X_scale = 0.0068;
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale = 0.0164;
    int8_t dLdO[384] = {
        -6, -36, -17, -25,  33,  -5,  -7,  10,  16,  12,  43, -43, -51,  50,
        -50, -32,  45,  21,  39, -28,  31,  55,   6,  12,  34, -11, -17, -52,
        -57,   5,  20, -31, -37, -45, -55,  22,  51,  11,  22, -34,   3, -20,
        -18,  40,  -8, -29, -54,   7, -57,  48,  26, -50,  10, -12,  20,  58,
        41, -21,  58,  -6,  -1,   1, -45,  24,  14,  33,  13,  -3, -10,  24,
        -20, -34, -49,  21, -14, -43,  36,  11,   7,   6, -28,  43,   4,   7,
        -21, -14,  27, -12,  -4,  -3,  57,  24,   7,  27, -32,  39, -16, -46,
        56, -32,  23,  32,  33, -46,  43,  42,  -2, -16,  46, -22, -56,  31,
        52, -17,  55,  47,   3,  -9, -10,   6,  -6, -40,  29,  20, -10,  30,
        -45,   9,  18,  13,   1,   9,  53,  11,  47,  -9, -28,   5,  -3,  25,
        11,  24,  32,  26,  -5,  35,  -1,  34,  42,  39, -57, -26,  43, -21,
        37,  57,  -9,  25,  41,  12,  29,  51,  14, -16, -15, -30,   9,  39,
        56, -12,  27, -43,  40,  57, -52,  46, -49, -51,  22,  -2, -33,  -7,
        -57,  32, -28,  56,  47,  48, -29,   2,  31,  39, -43,  21,  32, -51,
        35,  14, -22,  35,  -7,   3,  13, -25, -32,  -3,  34,  23, -32, -27,
        -27, -31, -40, -19, -23,  54,  13,  12, -16, -37,  31, -46, -37,  20,
        -4,  42,  45,  53,  -9, -28, -59,  23,  29,  16,  48, -38, -25,  20,
        51, -54, -29, -50, -30, -42,  27, -58,  40,  -4,  54, -34, -37, -14,
        -42,  -3, -36,  36,  26,  24,  52,  -5, -39, -44,   2,  44, -37,  -9,
        43, -50, -10,  45, -25, -54,  56, -28, -12,  -3, -24, -35,  18,  52,
        -21, -49,  42,  -2,  31,  44,  17,  12, -54,  38,  -4,   5, -25,  39,
        25, -33, -22, -48,  31, -50, -37,  29, -24,  43, -20,   0, -25,   2,
        -25,  13,  47, -45, -12,  51, -45,  27, -36,  57,  10,   0, -57,  56,
        28, -24,  49,   5, -51, -11, -24,  -3, -29,  35, -57,  54, -53,  14,
        -44,  42, -42, -23, -38, -36,  19,  -3,  51,   0, -26, -30, -21, -58,
        45,  21, -49, -11, -29,  14,   5, -51,  22,   5, -25,  29,   3, -29,
        57,   8, -20, -32,  18, -17,  39,  -8, -45, -57,  -2,   9,  16, -37,
        -33, -41,  53, -54,  22,  15
    };
    float dLdO_scale = 0.0170;
    float dLdX[1536];
    for (int i = 0; i < 1536; i++) {
        dLdX[i] = 0.0f;
    }
    float expected_dLdX[1536] = {
        0.0630055, 0.359686, 0.167985, 0.253749, -0.334338, 0.0506311, 0.0634343, -0.0967107, -0.159064, -0.124919, -0.428964, 0.426621, 0.513312, -0.505313, 0.503516, 0.32473,
        -0.445297, -0.217289, -0.394454, 0.27989, -0.309442, -0.541303, -0.0653489, -0.12439, -0.348574, 0.100434, 0.171368, 0.52134, 0.564342, -0.0495487, -0.192, 0.312514,
        0.363298, 0.447505, 0.550512, -0.221882, -0.509213, -0.114835, -0.227602, 0.342184, -0.0271033, 0.200457, 0.17804, -0.404227, 0.0733831, 0.288822, 0.545837, -0.0748338,
        0.567731, -0.479718, -0.259269, 0.499675, -0.100387, 0.11665, -0.199482, -0.583318, -0.41222, 0.209449, -0.58195, 0.0554593, 0.00677979, -0.00476987, 0.454652, -0.23065,
        -0.181716, -0.136715, -0.0123592, -0.0951821, -0.546108, -0.115703, -0.488166, 0.0906274, 0.290198, -0.0461244, 0.0314502, -0.259481, -0.119675, -0.240722, -0.335885, -0.265372,
        0.0510654, -0.359746, 0.00616409, -0.358781, -0.434693, -0.406861, 0.581654, 0.261297, -0.441641, 0.221282, -0.382405, -0.580178, 0.100812, -0.264261, -0.426057, -0.125426,
        -0.294984, -0.52809, -0.136813, 0.164597, 0.161026, 0.309753, -0.0943198, -0.404589, -0.584405, 0.120124, -0.277032, 0.44676, -0.419529, -0.589792, 0.535377, -0.483599,
        0.512622, 0.52178, -0.225296, 0.0169358, 0.339517, 0.0757364, 0.594771, -0.330037, 0.292852, -0.577032, -0.4827, -0.494269, 0.304361, -0.0236628, -0.323181, -0.406472,
        0.157451, 0.368028, 0.15185, -0.0380259, -0.112725, 0.26855, -0.217765, -0.383781, -0.547967, 0.231347, -0.160737, -0.473619, 0.399822, 0.120798, 0.080283, 0.0664784,
        -0.315177, 0.480577, 0.0400077, 0.0810503, -0.235524, -0.154611, 0.300796, -0.132714, -0.049587, -0.0355791, 0.641517, 0.265219, 0.0778369, 0.299812, -0.36107, 0.434586,
        -0.177322, -0.51397, 0.630643, -0.363071, 0.258838, 0.361405, 0.369314, -0.510291, 0.486748, 0.466956, -0.0135462, -0.174633, 0.511321, -0.240875, -0.625423, 0.349732,
        0.573563, -0.182673, 0.614327, 0.521905, 0.0251335, -0.0930318, -0.105676, 0.0688656, -0.0567687, -0.453059, 0.317184, 0.225982, -0.114181, 0.33251, -0.501228, 0.102751,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.101948, -0.582002, -0.271814, -0.410587, 0.540987, -0.0819254, -0.102642, 0.156486, 0.257379, 0.202129, 0.694099, -0.690307, -0.830581, 0.817638, -0.81473, -0.52544,
        0.720527, 0.351592, 0.638259, -0.452884, 0.500704, 0.875872, 0.10574, 0.201274, 0.564022, -0.162511, -0.277288, -0.843572, -0.913153, 0.080174, 0.310672, -0.505674,
        -0.587846, -0.7241, -0.890773, 0.359023, 0.823948, 0.185812, 0.368279, -0.553683, 0.0438554, -0.324356, -0.288083, 0.654072, -0.11874, -0.467339, -0.883209, 0.121087,
        -0.918636, 0.776224, 0.419519, -0.808515, 0.162435, -0.188749, 0.322779, 0.943857, 0.667006, -0.338905, 0.941643, -0.0897378, -0.0109703, 0.00771805, -0.735665, 0.373211,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.217234, 0.163437, 0.0147748, 0.113786, 0.652848, 0.138318, 0.583581, -0.108341, -0.346919, 0.0551397, -0.0375974, 0.310198, 0.143066, 0.287772, 0.401536, 0.31724,
        -0.0610464, 0.430061, -0.0073689, 0.428906, 0.519656, 0.486384, -0.695341, -0.312369, 0.527962, -0.264533, 0.457148, 0.693577, -0.120516, 0.315912, 0.509333, 0.149941,
        0.35264, 0.631308, 0.163553, -0.196768, -0.192499, -0.370296, 0.112755, 0.483668, 0.69863, -0.143603, 0.331179, -0.534082, 0.501528, 0.705069, -0.64002, 0.578121,
        -0.612817, -0.623765, 0.269331, -0.020246, -0.405878, -0.0905395, -0.711023, 0.394545, -0.350092, 0.689816, 0.577047, 0.590877, -0.363849, 0.0282879, 0.386348, 0.485919,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.0255717, -0.00610609, -0.0125945, 0.0256315, 0.136352, -0.000809473, 0.133767, 0.0182469, -0.0107244, -0.012945, 0.00913045, 0.107446, -0.0132324, 0.0427895, 0.0686696, 0.0539439,
        0.0203284, 0.033475, -0.00547283, 0.0738283, 0.123341, 0.108758, -0.163582, -0.0462853, 0.106047, -0.0469977, 0.0223131, 0.105762, -0.0309622, 0.0299934, 0.134115, -0.0154475,
        0.0854759, 0.17298, -0.0327538, -0.00077431, -0.0631157, -0.107549, -0.0159332, 0.144359, 0.0842316, -0.0748963, 0.0647377, -0.0844469, 0.0440262, 0.159358, -0.058935, 0.0750903,
        -0.175494, -0.100789, -0.0108591, -0.0568758, -0.0802059, -0.00787434, -0.125303, 0.0684915, -0.0612152, 0.177988, 0.0781901, 0.0900982, -0.0580168, -0.0283561, 0.124819, 0.0825323,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.0290192, -0.165665, -0.0773711, -0.116872, 0.15399, -0.0233198, -0.0292167, 0.0445432, 0.0732622, 0.0575354, 0.197573, -0.196494, -0.236422, 0.232738, -0.23191, -0.149565,
        0.205096, 0.10008, 0.181679, -0.128912, 0.142524, 0.249314, 0.0300985, 0.0572919, 0.160547, -0.0462582, -0.0789292, -0.24012, -0.259926, 0.0228213, 0.0884319, -0.143938,
        -0.167329, -0.206113, -0.253556, 0.102195, 0.234534, 0.0528909, 0.10483, -0.157604, 0.0124833, -0.0923271, -0.0820021, 0.18618, -0.033799, -0.133026, -0.251403, 0.0344671,
        -0.261487, 0.22095, 0.119415, -0.230141, 0.0462366, -0.0537267, 0.091878, 0.268666, 0.189861, -0.0964684, 0.268036, -0.0255436, -0.00312265, 0.00219692, -0.209405, 0.106233,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };
    float dLdW_val[8] = {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f};
    float expected_dLdW_val[8] = {
        2.86988, 2.6798, 2.35642, -0.574233, -2.91686, 2.39239, -4.51477, -1.17145
    };

    sparse::quantized_sparse_conv2d_vectorized_backward_stride_2(
        B, IC, OC, M, N, K, 8, 0, X, X_scale, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, dLdO, dLdO_scale, dLdX, dLdW_val
    );

    for (int i = 0; i < 1536; i++) {
        ASSERT_THAT(dLdX[i], testing::FloatNear(expected_dLdX[i], 0.025f));
    }

    for (int i = 0; i < 8; i++) {
        ASSERT_THAT(dLdW_val[i], testing::FloatNear(expected_dLdW_val[i], 0.3f));
    }
}

TEST(Test_Sparse, QuantizeSparseConv2dBackwardParallel1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        120,    1,   24,  116,   73,  127,  -25,   -6,  -90,  -39,   88,  -60,
        -121, -128, -107,   20, -118,  -43,   63, -116,   96,  -36,  118,   32,
        61,   25,    3,  -74,   13,  -14,  127,  -12,  -93,  -41,    7,   59,
        -40,   93, -115, -110, -124,  -25,  -46,   -4,   -8,  -80,  -10,  -95,
        31,   85,  127,  127,   18,   56,  -87,  -94,   15,   17,  114,  105,
        109, -128,    0,  100,  -79,   23, -124,  -71,   49, -128,  -11,  107,
        11, -100,  117,   89,   15,  127,   77,  -30,  -74,   45,   72,   43,
        54,   36,  -86,  122,  -43,  -10,  -44,   57,   98,  112,  127,  -79,
        -12,  127, -101,  125,    5,  -59,   91, -111,  127,  102,  -65,  127,
        -117,  -32,   72,   83,  -37,  -35,  -87,  127,  -70,   97,   94,  -27,
        -35,  127,   93,  -37,  -28,  -44,  115, -128, -121,  -86,  -45,  -46,
        -74,  101,  127,  116,   31,  127,  -22,   47,  111, -103,  127,  -40,
        -47,  108,   52,  -15,  101,  -61,   62,  -42, -107,   20,   20,   85,
        -128, -110,  127, -124,  -33,  -34,  -83, -118, -126,  -30,   12,  -47,
        23,   34, -105,  123,  127,  127, -107, -123,  -16, -112,   50,   77,
        -41,    8,  127, -124, -128,  -10,  -62,  -32,   98,   -3,  127,  -26,
        116, -128,   35,  -22,  -43,  127,   28,  104,  -13,   46,  109,  -98,
        -127,   -6,  -56,  127,  101,   54,   16,  -10,   26,  -57,    0,   26,
        -51, -114,  -80,  -81,  127, -113,   -4,  -49, -128,  -63,    3,   12,
        127,  -85,   74,   72,   95,  -49,  103,   53,   22,  127,    2,  -35,
        -68,  -29,  -91,  -10,  112,  112,   37,  -47,  -72,   53,   45,  -70,
        73,   12,  127,  -65,   32,  -42,  126,  -32,   98, -110,   44,  117,
        -77, -107, -128,   -1, -122,    8,   75,  -26, -123,   10,  -59,   24,
        -93,   10,   35,   87,   28,   37,   32,   31,  -82, -128,  108,  109,
        -124,  -96,   28,  -95,   71, -104,  127,  -67,  125,  127,  -20,   66,
        77,  -73,   54,   90,   60,   94,  -39,   -9,  -62,   79,   53,   88,
        -128, -128,   15,  -22,  -71,  -37,   37,  -31,   15, -116,    7, -128,
        -96,    4,   -9,  -87,   36,   73, -105, -105, -111,  -80,   27,  -82,
        -11,   37,  -38,  100,  107,   21,  -82,  -30,  -16,  -17,  -50, -115,
        127, -128,   91, -128, -102,  -33,  120,   -2,   53,   -5,   50, -125,
        72,  -68,  127, -128,  127,  -20,  -86, -128, -118,   54,    9,   75,
        24, -125,  -40, -121,   14,   68,   80, -128,  -94,  -87, -115,  -79,
        95,  -23,  -13,  -89,    6,  124,   57,   -9,  -20,  101,   51,  -18,
        -19,   18,  -14,  124,   32,  -38,   29,  110,  -27, -103,  -19, -128,
        -69,   35,  -52,  112, -101,   27,  117,  127,   64,  127,  -68,   49,
        118,  124,   49,  -59,  -71,  -49,   78,  127,  -20,  101,   -2, -118,
        84, -101,   75,    2,   26, -107,  -53,   -9, -128,   10,   71,  -32,
        74,  -83,  127, -128,  104,   86,   81,  -63,  103, -128,  127,   62,
        -65, -104,  -54,   83,  -86, -110, -128,   54, -128,  -97,  -33,  -70,
        -91,  -86, -115,  -75,   13,  -88, -109, -119,  -66,   83, -107,  -49,
        -9,  -50,  -97,  -47,  101, -128,  115,  -96,  -93,  -59,   46,   65,
        -91,   -1,   87, -128,  104, -128,   52, -128,  -38,   73,   94,   26,
        90,   22,  -25,   82,  127,   46,  -11, -128,  -80,   27,  127,  127,
        -90,  -12,  127,   17,   92,    5,  -75,  -74,  -89, -128,   45,   92,
        -44,   45,  127, -124,   52,  -42, -122,  108,    9,   60,  -87,   51,
        52,    7,  -69,   52, -126,   59,   20,  127,   27,  -17,   24,   38,
        36,  111,  127,  -28,  127,  112,  -50, -128,   35,  121, -128,  -55,
        119, -102, -107,   36,  -14,  -58,  -19,  -79,  108, -125,  -12,  -87,
        127,  127, -119,  -97, -104,  105,  -53,   63,  -33,  118,  107,   79,
        65,   -5,  127, -128,  110,  -73,  116,  127,  -56, -128,  -52,  -23,
        -13,  -78,   29,  -10,   83,   14, -127, -119,   55,  -15,  -18,  124,
        12,   61,  -60,   76,  127,  114,  -99,   19,  -78,    1,  -77,  -52,
        127,   23, -128,  -41,   53,  -48,  127,   97,  -19,  -11,   28,   88,
        39,   25,   25,  -26,  -41,  -97, -113,  102,   12, -123,  -30,   76,
        57,  127,  -78,  -52,   90,   96,  -95, -125,  -53,   56,  127, -128,
        -112, -128,  -37,  114,  -68,   40,  -76,   14,   -8,  -53, -127,   89,
        -120,   13,  -60,  -33,  -24,   26,  106,   76,   26,  127,   97,  -93,
        90,   51,  -51,  127,  108,  -34,  -64,  -19,   72,   63, -108,  127,
        -90, -123,  -86,  120,  -16,  -79,  127,  -94,   98,  -61,  -67,  -45,
        -115,   59,  -87,  -21,    1,  125,  -94, -116, -118,  -10,  -68,   74,
        -74,   27,   42,  106,   90,  -98,   49,  -68,    9,   17, -128,  -36,
        108,  -91, -121,   65,   53,  127,  -25,   44,   42,   79,  -91,   29,
        127,  -44,   42,  -28,   44,   83, -113,  -76,  -68,   27, -128,  -17,
        -56,  -21,  -49,  -57, -126,   62,  -73,   47,  -23,  118,  -59, -102,
        11,   20,  -30,  -54,  -41,  -84,   13,  -15,   56,  122,    9,   -6,
        108, -128,   62,   -3, -124,  -46, -114,  -24, -128,   59,   41,   56,
        -8,   30,  -58,  -55,   73,   -2,   20,  -24,   82,   78,  -59,   99,
        59,   19,  127,   75,   89, -128,   99,  107,  110,  -21,  123,  -73,
        18,  127,    0,   97,  103,   -6,  -60,  120,  -30,  -30,   15,  -92,
        -3,  127,  127, -112, -104,  -87, -125, -124,  -62, -118,  -82,   78,
        -93,   61,  109,  -41,   86,  127,   87,   23,  110, -128,  -77,  -83,
        -8, -109,  -14, -114,  -46,  118,  113,   66,  127,   36,  -53,  -73,
        -73,   27,   94,  -79,   31,  -25,  -92, -128, -128,   79,   51, -102,
        -55,  -14,  -45, -108,  -32,   27,  -47,   58,  -56,   42,   20,   84,
        64,    6,  -39,  -47,   71,  -92,   97,   43,   95,  -95,  -56,  -66,
        2,   99,  -52, -124,  -33,  -82,  -72, -107,   86,  106, -101,   78,
        60,  -51,  106,  127,  127,   84,   60,  -20,    9,   14,   43,  127,
        -12,   -1, -128,  -12, -128,   54,  -84, -107,   18,  -33,   55,    5,
        28,  127,   65,  -11, -105,   35,   22,  -72,   52,   82,  -30,  124,
        122,  -59, -128,   19,   97, -128, -109,   18, -105,  125,  -81,   29,
        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34, -128,  -73, -128,  127,   13,   -1,  -50,   74,
        -2, -127,   69,   25,  -44,   72,  113,   80,   49,   -4,  -15,  -95,
        -41,  124,  103,  -69,  -12, -103,    1,  115,  103,  -70,   59, -128,
        -34,  -17,   49,  -37,  -92,  -54,  -81, -106,   96, -128,  -23,  108,
        127, -122,    2,   83,  -33,  -89,  -47,  127, -128, -117,  -84,   -2,
        -128,   84,  -52,   87,  -58,   64,  -80,  -60,   28,   -6,  -58,   78,
        61,   11, -128,   86,   81, -120,  -84,  104,   85,  -16,  -39,  107,
        126,  -79,  -80,  -35,   99,  -80,  121,  127,  106, -119,   95,   61,
        -18,  -10,  100, -116,   99,  -10,    2,  -56,   78,   56,   43, -104,
        81,  -31,  -85,  102,  -82,  123,  115,   12,   -7,  -23, -104,  121,
        9,   -1,    1,  126,  127,  125,  127,   44, -105,  -81,   52,  -86,
        -52,   16,  117, -125,   17, -112,  -48,    4, -109,   16,  -59,   25,
        -82,  106, -128,   43,   48,   83, -126,  -66,  -94,  -83,    5,  100,
        55,  -89,  -95,  -13,  -10,  -31,   62, -100,   88, -123,  127,   71,
        -105,  127,   69,  127, -128,  -31, -105,   53,   83,  124,  -91,   61,
        -100,  -34, -128,    4,   98,  -79,  127,  127, -128,  -81,  127, -114,
        -59,  -79,   73,   49,   31,  -55,  101, -116,  125, -128,    1,  -94,
        -43,  -99,   -6,   19,  -97,  -27, -109, -108, -120,  -35,   50,   56,
        -18,  106,   28,  109,   55, -128,  -13,   66,   43,   89,  127,  127,
        96,  -67,   18,  -74,  -13,  104,  -81,  -13,   -4, -110,   35,  109,
        -96,  113,    8,  -44,    5,   39,  -73,   49,   83,   46,  102,   57,
        109,  114,  -56, -120,  -38,  -88,  -93,   37,  -71,   26,   22,   85,
        127,  127,   67,  127,   -8,  122,   46,    0,  -80,   87, -111,  127,
        -44,   17,    3,  112,  108,  112,  -26,  -60,  -81,  118,  -75, -128,
        -45,  -52,  -87,  -26,  -15,  -50, -128,   93,  126,  127,   31,  -57,
        -17,   21,   87,  102,  112, -127, -118,  125,  -40,  127,   57,    4,
        -83, -111, -112,  -88,   62,  -78, -128,   54,  -75,   84,  -21,   72,
        127,  -35,  -73, -117,  127,   69,   50,  -80,   81, -114, -128,   92,
        -107, -108,  105,   -4,  -54,   57,  -49,  127,  -82,  127,  -80,   43,
        63,   24,   23,  -23,   57,  -77,   42,  127, -128,   30,   13,  -41,
        -65,  -67,   18, -128, -128,   92,   64,  -77,   58,  101, -108,   36,
        55, -121,   54,   91,  -13,   24,   66,   50, -128,  -86, -128,   40,
        127,  127, -128,  -32,  -25, -113,  125,   14,  -15, -101,  -20,  -38,
        -31,   65,  -68, -119,  -76,   -4,  -73,   52,   87,   19,   30,   48,
        118,  109,   51,  -43,  -81,  -71,   20,  108,   10, -102, -128,   -4,
        -80,   38, -128,  -84,   43,  127,   21,  -16,  127,  -16,   33,  108,
        -114,   69,   52,  127,  -60, -124, -128,  -73,  127,  127,  116,  -68,
        -78,  -68,   41,   85,  -84,  113,   53,  -89,   59,  -95,  -48,    2,
        76, -106,  -59,   23,   31,  -32,  -43,  -67, -128,  -40,  -14,  127,
        41,  -91,  -59,  127,   35,   71,  -84, -128,  127,   93,  127,   40,
        -125,   77,  127, -128,  127,  -63, -125,  -86,  -93, -117,  125,   72,
        -4,  -53,  127, -106,   -8,  127, -106,  127, -108,  -47,   37,   97,
        127,  127,  -30,   71,   25,   44,  -34,  -71,   72,  125,   18,  127
    };
    float X_scale = 0.0068;
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale = 0.0164;
    int8_t dLdO[384] = {
        -6, -36, -17, -25,  33,  -5,  -7,  10,  16,  12,  43, -43, -51,  50,
        -50, -32,  45,  21,  39, -28,  31,  55,   6,  12,  34, -11, -17, -52,
        -57,   5,  20, -31, -37, -45, -55,  22,  51,  11,  22, -34,   3, -20,
        -18,  40,  -8, -29, -54,   7, -57,  48,  26, -50,  10, -12,  20,  58,
        41, -21,  58,  -6,  -1,   1, -45,  24,  14,  33,  13,  -3, -10,  24,
        -20, -34, -49,  21, -14, -43,  36,  11,   7,   6, -28,  43,   4,   7,
        -21, -14,  27, -12,  -4,  -3,  57,  24,   7,  27, -32,  39, -16, -46,
        56, -32,  23,  32,  33, -46,  43,  42,  -2, -16,  46, -22, -56,  31,
        52, -17,  55,  47,   3,  -9, -10,   6,  -6, -40,  29,  20, -10,  30,
        -45,   9,  18,  13,   1,   9,  53,  11,  47,  -9, -28,   5,  -3,  25,
        11,  24,  32,  26,  -5,  35,  -1,  34,  42,  39, -57, -26,  43, -21,
        37,  57,  -9,  25,  41,  12,  29,  51,  14, -16, -15, -30,   9,  39,
        56, -12,  27, -43,  40,  57, -52,  46, -49, -51,  22,  -2, -33,  -7,
        -57,  32, -28,  56,  47,  48, -29,   2,  31,  39, -43,  21,  32, -51,
        35,  14, -22,  35,  -7,   3,  13, -25, -32,  -3,  34,  23, -32, -27,
        -27, -31, -40, -19, -23,  54,  13,  12, -16, -37,  31, -46, -37,  20,
        -4,  42,  45,  53,  -9, -28, -59,  23,  29,  16,  48, -38, -25,  20,
        51, -54, -29, -50, -30, -42,  27, -58,  40,  -4,  54, -34, -37, -14,
        -42,  -3, -36,  36,  26,  24,  52,  -5, -39, -44,   2,  44, -37,  -9,
        43, -50, -10,  45, -25, -54,  56, -28, -12,  -3, -24, -35,  18,  52,
        -21, -49,  42,  -2,  31,  44,  17,  12, -54,  38,  -4,   5, -25,  39,
        25, -33, -22, -48,  31, -50, -37,  29, -24,  43, -20,   0, -25,   2,
        -25,  13,  47, -45, -12,  51, -45,  27, -36,  57,  10,   0, -57,  56,
        28, -24,  49,   5, -51, -11, -24,  -3, -29,  35, -57,  54, -53,  14,
        -44,  42, -42, -23, -38, -36,  19,  -3,  51,   0, -26, -30, -21, -58,
        45,  21, -49, -11, -29,  14,   5, -51,  22,   5, -25,  29,   3, -29,
        57,   8, -20, -32,  18, -17,  39,  -8, -45, -57,  -2,   9,  16, -37,
        -33, -41,  53, -54,  22,  15
    };
    float dLdO_scale = 0.0170;
    float dLdX[1536];
    for (int i = 0; i < 1536; i++) {
        dLdX[i] = 0.0f;
    }
    float expected_dLdX[1536] = {
        0.0630055, 0.359686, 0.167985, 0.253749, -0.334338, 0.0506311, 0.0634343, -0.0967107, -0.159064, -0.124919, -0.428964, 0.426621, 0.513312, -0.505313, 0.503516, 0.32473,
        -0.445297, -0.217289, -0.394454, 0.27989, -0.309442, -0.541303, -0.0653489, -0.12439, -0.348574, 0.100434, 0.171368, 0.52134, 0.564342, -0.0495487, -0.192, 0.312514,
        0.363298, 0.447505, 0.550512, -0.221882, -0.509213, -0.114835, -0.227602, 0.342184, -0.0271033, 0.200457, 0.17804, -0.404227, 0.0733831, 0.288822, 0.545837, -0.0748338,
        0.567731, -0.479718, -0.259269, 0.499675, -0.100387, 0.11665, -0.199482, -0.583318, -0.41222, 0.209449, -0.58195, 0.0554593, 0.00677979, -0.00476987, 0.454652, -0.23065,
        -0.181716, -0.136715, -0.0123592, -0.0951821, -0.546108, -0.115703, -0.488166, 0.0906274, 0.290198, -0.0461244, 0.0314502, -0.259481, -0.119675, -0.240722, -0.335885, -0.265372,
        0.0510654, -0.359746, 0.00616409, -0.358781, -0.434693, -0.406861, 0.581654, 0.261297, -0.441641, 0.221282, -0.382405, -0.580178, 0.100812, -0.264261, -0.426057, -0.125426,
        -0.294984, -0.52809, -0.136813, 0.164597, 0.161026, 0.309753, -0.0943198, -0.404589, -0.584405, 0.120124, -0.277032, 0.44676, -0.419529, -0.589792, 0.535377, -0.483599,
        0.512622, 0.52178, -0.225296, 0.0169358, 0.339517, 0.0757364, 0.594771, -0.330037, 0.292852, -0.577032, -0.4827, -0.494269, 0.304361, -0.0236628, -0.323181, -0.406472,
        0.157451, 0.368028, 0.15185, -0.0380259, -0.112725, 0.26855, -0.217765, -0.383781, -0.547967, 0.231347, -0.160737, -0.473619, 0.399822, 0.120798, 0.080283, 0.0664784,
        -0.315177, 0.480577, 0.0400077, 0.0810503, -0.235524, -0.154611, 0.300796, -0.132714, -0.049587, -0.0355791, 0.641517, 0.265219, 0.0778369, 0.299812, -0.36107, 0.434586,
        -0.177322, -0.51397, 0.630643, -0.363071, 0.258838, 0.361405, 0.369314, -0.510291, 0.486748, 0.466956, -0.0135462, -0.174633, 0.511321, -0.240875, -0.625423, 0.349732,
        0.573563, -0.182673, 0.614327, 0.521905, 0.0251335, -0.0930318, -0.105676, 0.0688656, -0.0567687, -0.453059, 0.317184, 0.225982, -0.114181, 0.33251, -0.501228, 0.102751,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.101948, -0.582002, -0.271814, -0.410587, 0.540987, -0.0819254, -0.102642, 0.156486, 0.257379, 0.202129, 0.694099, -0.690307, -0.830581, 0.817638, -0.81473, -0.52544,
        0.720527, 0.351592, 0.638259, -0.452884, 0.500704, 0.875872, 0.10574, 0.201274, 0.564022, -0.162511, -0.277288, -0.843572, -0.913153, 0.080174, 0.310672, -0.505674,
        -0.587846, -0.7241, -0.890773, 0.359023, 0.823948, 0.185812, 0.368279, -0.553683, 0.0438554, -0.324356, -0.288083, 0.654072, -0.11874, -0.467339, -0.883209, 0.121087,
        -0.918636, 0.776224, 0.419519, -0.808515, 0.162435, -0.188749, 0.322779, 0.943857, 0.667006, -0.338905, 0.941643, -0.0897378, -0.0109703, 0.00771805, -0.735665, 0.373211,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.217234, 0.163437, 0.0147748, 0.113786, 0.652848, 0.138318, 0.583581, -0.108341, -0.346919, 0.0551397, -0.0375974, 0.310198, 0.143066, 0.287772, 0.401536, 0.31724,
        -0.0610464, 0.430061, -0.0073689, 0.428906, 0.519656, 0.486384, -0.695341, -0.312369, 0.527962, -0.264533, 0.457148, 0.693577, -0.120516, 0.315912, 0.509333, 0.149941,
        0.35264, 0.631308, 0.163553, -0.196768, -0.192499, -0.370296, 0.112755, 0.483668, 0.69863, -0.143603, 0.331179, -0.534082, 0.501528, 0.705069, -0.64002, 0.578121,
        -0.612817, -0.623765, 0.269331, -0.020246, -0.405878, -0.0905395, -0.711023, 0.394545, -0.350092, 0.689816, 0.577047, 0.590877, -0.363849, 0.0282879, 0.386348, 0.485919,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.0255717, -0.00610609, -0.0125945, 0.0256315, 0.136352, -0.000809473, 0.133767, 0.0182469, -0.0107244, -0.012945, 0.00913045, 0.107446, -0.0132324, 0.0427895, 0.0686696, 0.0539439,
        0.0203284, 0.033475, -0.00547283, 0.0738283, 0.123341, 0.108758, -0.163582, -0.0462853, 0.106047, -0.0469977, 0.0223131, 0.105762, -0.0309622, 0.0299934, 0.134115, -0.0154475,
        0.0854759, 0.17298, -0.0327538, -0.00077431, -0.0631157, -0.107549, -0.0159332, 0.144359, 0.0842316, -0.0748963, 0.0647377, -0.0844469, 0.0440262, 0.159358, -0.058935, 0.0750903,
        -0.175494, -0.100789, -0.0108591, -0.0568758, -0.0802059, -0.00787434, -0.125303, 0.0684915, -0.0612152, 0.177988, 0.0781901, 0.0900982, -0.0580168, -0.0283561, 0.124819, 0.0825323,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.0290192, -0.165665, -0.0773711, -0.116872, 0.15399, -0.0233198, -0.0292167, 0.0445432, 0.0732622, 0.0575354, 0.197573, -0.196494, -0.236422, 0.232738, -0.23191, -0.149565,
        0.205096, 0.10008, 0.181679, -0.128912, 0.142524, 0.249314, 0.0300985, 0.0572919, 0.160547, -0.0462582, -0.0789292, -0.24012, -0.259926, 0.0228213, 0.0884319, -0.143938,
        -0.167329, -0.206113, -0.253556, 0.102195, 0.234534, 0.0528909, 0.10483, -0.157604, 0.0124833, -0.0923271, -0.0820021, 0.18618, -0.033799, -0.133026, -0.251403, 0.0344671,
        -0.261487, 0.22095, 0.119415, -0.230141, 0.0462366, -0.0537267, 0.091878, 0.268666, 0.189861, -0.0964684, 0.268036, -0.0255436, -0.00312265, 0.00219692, -0.209405, 0.106233,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };
    float dLdW_val[8] = {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f};
    float expected_dLdW_val[8] = {
        2.86988, 2.6798, 2.35642, -0.574233, -2.91686, 2.39239, -4.51477, -1.17145
    };

    sparse::quantized_sparse_conv2d_vectorized_parallel_backward_stride_2(
        B, IC, OC, M, N, K, 8, 0, X, X_scale, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, dLdO, dLdO_scale, dLdX, dLdW_val
    );

    for (int i = 0; i < 1536; i++) {
        ASSERT_THAT(dLdX[i], testing::FloatNear(expected_dLdX[i], 0.025f));
    }

    for (int i = 0; i < 8; i++) {
        ASSERT_THAT(dLdW_val[i], testing::FloatNear(expected_dLdW_val[i], 0.3f));
    }
}

TEST(Test_Sparse, QuantizeGroupedSparseConv2dForward1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        97,    1,   19,   94,   59,  117,  -20,   -5,  -73,  -32,   71,  -48,
        -98, -105,  -86,   16,  -96,  -35,   51,  -94,   78,  -29,   95,   26,
        49,   20,    2,  -59,   10,  -11,  107,  -10,  -75,  -33,    6,   48,
        -32,   75,  -92,  -89, -100,  -20,  -37,   -3,   -6,  -65,   -8,  -77,
        25,   68,  108,  117,   14,   45,  -70,  -76,   12,   14,   92,   84,
        88, -103,    0,   81,

        -88,   26, -128,  -80,   54, -128,  -13,  120,   13, -112,  127,   99,
        17,  127,   86,  -33,  -82,   50,   80,   48,   61,   41,  -96,  127,
        -49,  -12,  -50,   63,  110,  125,  127,  -89,  -13,  127, -113,  127,
        5,  -65,  102, -124,  127,  114,  -73,  127, -128,  -35,   80,   92,
        -41,  -39,  -97,  127,  -78,  108,  105,  -31,  -39,  127,  104,  -41,
        -31,  -50,  127, -128,

        -113,  -80,  -42,  -43,  -69,   95,  127,  108,   29,  127,  -21,   44,
        104,  -96,  127,  -38,  -44,  101,   49,  -14,   95,  -57,   58,  -39,
        -100,   19,   19,   80, -128, -103,  120, -116,  -30,  -32,  -78, -110,
        -118,  -28,   11,  -44,   21,   32,  -99,  115,  127,  127, -100, -115,
        -15, -105,   47,   72,  -38,    8,  127, -116, -120,  -10,  -58,  -30,
        91,   -3,  122,  -24,

        101, -112,   30,  -19,  -37,  115,   24,   90,  -11,   40,   95,  -85,
        -110,   -6,  -48,  124,   88,   47,   14,   -8,   23,  -50,    0,   23,
        -44,  -98,  -69,  -70,  123,  -98,   -3,  -42, -125,  -55,    3,   10,
        119,  -73,   64,   63,   82,  -42,   89,   46,   19,  110,    2,  -31,
        -59,  -25,  -79,   -8,   97,   97,   32,  -41,  -63,   46,   39,  -60,
        63,   11,  121,  -56,

        32,  -43,  127,  -32,  100, -112,   45,  120,  -79, -109, -128,   -1,
        -125,    8,   77,  -27, -126,   10,  -61,   25,  -96,   10,   35,   89,
        29,   37,   32,   32,  -84, -128,  111,  112, -127,  -99,   29,  -97,
        72, -107,  127,  -68,  127,  127,  -20,   67,   78,  -75,   56,   92,
        61,   96,  -40,   -9,  -64,   81,   54,   90, -128, -128,   15,  -22,
        -73,  -37,   38,  -32,

        14, -107,    6, -118,  -88,    4,   -8,  -80,   33,   68,  -96,  -97,
        -102,  -74,   25,  -76,  -10,   34,  -35,   92,   98,   19,  -76,  -28,
        -15,  -16,  -46, -106,  120, -123,   84, -128,  -94,  -30,  110,   -2,
        49,   -5,   46, -116,   67,  -63,  117, -126,  124,  -18,  -79, -120,
        -109,   50,    8,   70,   22, -116,  -37, -111,   13,   63,   73, -123,
        -87,  -80, -106,  -72,

        82,  -20,  -11,  -77,    5,  107,   49,   -8,  -17,   88,   44,  -15,
        -17,   15,  -12,  107,   28,  -33,   25,   95,  -24,  -89,  -16, -116,
        -59,   30,  -45,   96,  -88,   23,  101,  114,   55,  115,  -58,   42,
        102,  107,   42,  -51,  -62,  -42,   68,  126,  -17,   87,   -2, -102,
        72,  -87,   65,    2,   23,  -92,  -46,   -8, -117,    8,   61,  -28,
        64,  -72,  121, -111,

        127,  127,  121,  -93,  127, -128,  127,   92,  -97, -128,  -81,  124,
        -127, -128, -128,   80, -128, -128,  -48, -104, -128, -128, -128, -111,
        19, -128, -128, -128,  -99,  124, -128,  -72,  -13,  -74, -128,  -70,
        127, -128,  127, -128, -128,  -88,   69,   96, -128,   -2,  127, -128,
        127, -128,   78, -128,  -57,  109,  127,   39,  127,   33,  -37,  122,
        127,   68,  -17, -128,

        -74,   25,  127,  123,  -83,  -11,  127,   16,   85,    4,  -69,  -68,
        -82, -127,   41,   85,  -41,   42,  126, -115,   48,  -39, -113,  100,
        8,   56,  -81,   47,   48,    7,  -64,   48, -117,   54,   18,  117,
        25,  -15,   22,   35,   34,  102,  122,  -26,  127,  104,  -46, -128,
        33,  112, -126,  -51,  110,  -95,  -99,   33,  -13,  -53,  -17,  -73,
        100, -116,  -11,  -81,

        114,  114, -106,  -86,  -93,   93,  -47,   56,  -29,  105,   96,   71,
        58,   -5,  126, -122,   98,  -65,  104,  114,  -50, -116,  -46,  -20,
        -11,  -70,   26,   -9,   74,   12, -113, -106,   49,  -13,  -16,  111,
        11,   54,  -54,   67,  119,  102,  -88,   17,  -69,    1,  -69,  -46,
        121,   21, -123,  -36,   48,  -43,  127,   86,  -17,  -10,   25,   79,
        35,   23,   23,  -23,

        -50, -118, -128,  125,   15, -128,  -37,   93,   69,  127,  -95,  -64,
        110,  118, -116, -128,  -65,   69,  127, -128, -128, -128,  -45,  127,
        -83,   49,  -93,   17,  -10,  -65, -128,  108, -128,   16,  -73,  -41,
        -30,   32,  127,   93,   32,  127,  119, -114,  110,   63,  -62,  127,
        127,  -41,  -78,  -23,   88,   77, -128,  127, -111, -128, -105,  127,
        -19,  -97,  127, -115,

        116,  -73,  -80,  -53, -128,   70, -103,  -25,    2,  127, -111, -128,
        -128,  -12,  -81,   88,  -88,   32,   50,  126,  107, -116,   59,  -81,
        11,   20, -128,  -43,  127, -108, -128,   77,   63,  127,  -29,   53,
        50,   94, -107,   34,  127,  -52,   50,  -33,   52,   98, -128,  -90,
        -81,   32, -128,  -20,  -66,  -24,  -58,  -67, -128,   73,  -87,   56,
        -28,  127,  -70, -121,

        9,   16,  -24,  -43,  -33,  -67,   10,  -12,   44,   98,    7,   -5,
        86, -108,   49,   -3,  -99,  -36,  -91,  -19, -108,   47,   32,   44,
        -7,   24,  -46,  -43,   58,   -2,   16,  -19,   66,   63,  -47,   79,
        47,   15,  105,   60,   71, -107,   79,   85,   88,  -17,   98,  -58,
        14,  110,    0,   77,   82,   -5,  -48,   96,  -24,  -24,   12,  -73,
        -2,  102,  109,  -89,

        -128, -117, -128, -128,  -82, -128, -109,  104, -124,   82,  127,  -55,
        115,  127,  117,   31,  127, -128, -103, -111,  -11, -128,  -18, -128,
        -61,  127,  127,   88,  127,   48,  -70,  -97,  -98,   36,  126, -106,
        42,  -33, -123, -128, -128,  106,   68, -128,  -73,  -18,  -61, -128,
        -43,   36,  -63,   77,  -75,   56,   26,  112,   86,    9,  -52,  -63,
        95, -123,  127,   58,

        90,  -89,  -53,  -62,    2,   93,  -49, -116,  -31,  -77,  -67, -100,
        80,   99,  -95,   73,   56,  -48,   99,  122,  127,   79,   56,  -18,
        9,   13,   41,  123,  -12,   -1, -128,  -11, -128,   50,  -79, -101,
        17,  -31,   52,    5,   27,  127,   61,  -10,  -99,   32,   21,  -67,
        49,   76,  -28,  116,  115,  -55, -128,   17,   91, -120, -102,   17,
        -98,  117,  -76,   27,

        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34,

        -128,  -71, -128,  127,   13,   -1,  -49,   71,   -2, -123,   67,   24,
        -43,   69,  108,   77,   47,   -4,  -15,  -92,  -39,  119,  100,  -66,
        -11,  -99,    1,  111,  100,  -67,   57, -128,  -33,  -16,   47,  -36,
        -88,  -52,  -78, -102,   93, -128,  -22,  104,  127, -117,    2,   80,
        -31,  -85,  -45,  127, -128, -113,  -81,   -2, -128,   81,  -50,   84,
        -55,   61,  -77,  -58,

        28,   -6,  -58,   79,   62,   11, -128,   87,   81, -121,  -85,  105,
        86,  -16,  -40,  108,  127,  -80,  -81,  -35,  100,  -81,  122,  127,
        107, -120,   95,   62,  -19,  -10,  100, -117,  100,  -10,    2,  -56,
        78,   57,   43, -105,   82,  -31,  -85,  102,  -83,  123,  116,   13,
        -7,  -23, -105,  122,    9,   -1,    1,  126,  127,  126,  127,   44,
        -105,  -81,   52,  -86,

        -61,   18,  127, -128,   20, -128,  -56,    4, -128,   18,  -69,   29,
        -95,  123, -128,   50,   56,   97, -128,  -77, -110,  -96,    6,  117,
        64, -103, -111,  -15,  -11,  -37,   73, -117,  103, -128,  127,   83,
        -122,  127,   80,  127, -128,  -36, -122,   61,   97,  127, -107,   71,
        -117,  -39, -128,    5,  114,  -92,  127,  127, -128,  -95,  127, -128,
        -68,  -92,   85,   57,

        32,  -57,  104, -119,  127, -128,    1,  -97,  -45, -102,   -6,   20,
        -100,  -27, -112, -112, -123,  -36,   51,   58,  -19,  109,   29,  113,
        56, -128,  -14,   68,   45,   92,  127,  127,   99,  -69,   19,  -76,
        -13,  107,  -83,  -14,   -4, -114,   36,  112,  -99,  117,    8,  -45,
        5,   40,  -75,   51,   86,   48,  105,   59,  113,  117,  -58, -124,
        -40,  -90,  -96,   38,

        -72,   26,   23,   87,  127,  127,   69,  127,   -8,  125,   47,    0,
        -82,   89, -113,  127,  -45,   17,    3,  114,  110,  114,  -26,  -62,
        -83,  120,  -77, -128,  -45,  -53,  -89,  -26,  -15,  -51, -128,   95,
        127,  127,   32,  -58,  -17,   21,   89,  104,  114, -128, -120,  127,
        -41,  127,   58,    4,  -85, -113, -114,  -90,   63,  -80, -128,   55,
        -77,   86,  -22,   74,

        127,  -41,  -83, -128,  127,   79,   58,  -92,   93, -128, -128,  105,
        -122, -124,  120,   -5,  -62,   65,  -56,  127,  -94,  127,  -92,   49,
        73,   28,   26,  -26,   65,  -89,   48,  127, -128,   35,   15,  -47,
        -74,  -77,   21, -128, -128,  106,   73,  -89,   67,  116, -124,   41,
        63, -128,   61,  104,  -15,   27,   76,   58, -128,  -98, -128,   45,
        127,  127, -128,  -37,

        -26, -118,  127,   15,  -16, -105,  -21,  -40,  -32,   68,  -71, -125,
        -80,   -4,  -76,   54,   91,   20,   31,   50,  124,  114,   54,  -46,
        -85,  -75,   21,  114,   10, -107, -128,   -5,  -84,   39, -128,  -88,
        45,  127,   22,  -16,  127,  -17,   35,  113, -120,   72,   54,  127,
        -63, -128, -128,  -77,  127,  127,  121,  -71,  -82,  -71,   42,   89,
        -88,  119,   56,  -93,

        62, -101,  -51,    2,   81, -113,  -62,   24,   33,  -34,  -46,  -71,
        -128,  -42,  -15,  127,   44,  -97,  -63,  127,   37,   75,  -89, -128,
        127,   99,  127,   43, -128,   81,  127, -128,  127,  -66, -128,  -91,
        -98, -124,  127,   76,   -4,  -56,  127, -112,   -9,  127, -112,  127,
        -114,  -50,   40,  103,  127,  127,  -32,   76,   27,   46,  -36,  -75,
        77,  127,   19,  127
    };
    float X_scale[24] = {
        0.0085, 0.0061, 0.0073, 0.0079, 0.0067, 0.0074, 0.0079, 0.0046, 0.0074, 0.0077,
        0.0056, 0.0058, 0.0086, 0.0051, 0.0073, 0.0068, 0.0071, 0.0068, 0.0059, 0.0066,
        0.0067, 0.0060, 0.0065, 0.0065
    };
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale[1] = {0.0164f};
    float O[384];
    for (int i = 0; i < 384; i++) {
        O[i] = 0.0f;
    }
    float expected_O[384] = {
        -0.32751, -0.860379, 0.134698, -1.51122, -0.686316, -0.794174, 0.0456554, -0.710866,
        0.513953, 0.451265, -1.04393, -0.405387, -0.412326, -0.0451973, 0.406947, -0.81619,
        0.184438, 0.348267, -0.40773, 1.22317, 0.272505, 0.475616, -0.955179, -0.123118, -0.250479,
        -0.448769, -0.358889, -0.328313, 0.871675, -0.648493, 0.325087, -0.61935,
        -0.114082, -0.173579, 0.782683, -0.386986, 0.479132, -0.21721, 0.635533, -0.398349,
        0.961082, -0.547002, 1.07752, -0.672141, 0.72637, 0.404673, -0.505057, -0.54519,
        -0.882915, 0.0807834, -0.611832, -0.000362335, 0.236161, -0.95259, 0.277764, -0.303415,
        0.23266, 0.583722, -0.0424994, -1.50855, -1.12271, -0.213993, -0.920017, -0.844027,
        -0.479779, -0.388866, -0.166552, -0.211928, -0.281142, 0.423207, 0.54662, 0.487937,
        0.127642, 0.63223, -0.032759, 0.250923, 0.453613, -0.404463, 0.56085, -0.234346,
        -0.267176, 0.529325, 0.254168, -0.121234, 0.404612, -0.28319, 0.32044, -0.22726,
        -0.41468, 0.103772, 0.100662, 0.424448, -0.70226, -0.486457, 0.560101, -0.532022,
        -0.202998, -0.200795, -0.32097, -0.561242, -0.57707, -0.126074, -0.00623055, -0.194739,
        0.0756797, 0.207852, -0.484259, 0.539414, 0.584813, 0.70423, -0.512302, -0.541568,
        -0.0589088, -0.531225, 0.229951, 0.372922, -0.196719, 0.103608, 0.667556, -0.500211,
        -0.531643, -0.0282003, -0.28755, -0.0991532, 0.37283, -0.0384498, 0.626721, -0.0996101,
        0.715836, 0.336983, 0.845109, -0.00664388, 0.209212, -0.0920555, 0.859445, -0.0732012,
        -0.343603, -0.0544728, -0.894128, -0.0348023, -0.396101, -1.25667, -0.858363, 0.501175,
        -0.289538, -0.763826, -0.499975, -0.409396, -0.574964, -0.555887, -0.297915, -0.797998, 0.104374, -0.425556, -0.381074, -0.912793, -0.599471, -0.0678525, -1.06442, 0.0349895,
        0.124207, -0.726707, -0.170409, -0.68783, 0.50367, -0.443274, 0.316848, -0.0475457,
        -0.967834, -0.828863, 0.52571, -0.226864, 0.11864, 0.0209037, 0.200918, -1.03906, 0.637762, -0.433581, 0.606689, -1.25304, 0.130528, -0.177622, -0.0268916, 0.129266, 0.500518, -0.504546, -0.488596, 0.467866, 0.884753, 0.464907, -0.622268, -0.208384,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0
    };

    sparse::quantized_grouped_sparse_conv2d_vectorized_forward_stride_2(
        B, IC, OC, M, N, K, 8, 0,
        X, X_scale, 64, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, 64, O
    );

    for (int i = 0; i < 384; i++) {
        ASSERT_THAT(O[i], testing::FloatNear(expected_O[i], 0.3f));
    }
}

TEST(Test_Sparse, QuantizeGroupedSparseConv2dForwardParallel1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        97,    1,   19,   94,   59,  117,  -20,   -5,  -73,  -32,   71,  -48,
        -98, -105,  -86,   16,  -96,  -35,   51,  -94,   78,  -29,   95,   26,
        49,   20,    2,  -59,   10,  -11,  107,  -10,  -75,  -33,    6,   48,
        -32,   75,  -92,  -89, -100,  -20,  -37,   -3,   -6,  -65,   -8,  -77,
        25,   68,  108,  117,   14,   45,  -70,  -76,   12,   14,   92,   84,
        88, -103,    0,   81,

        -88,   26, -128,  -80,   54, -128,  -13,  120,   13, -112,  127,   99,
        17,  127,   86,  -33,  -82,   50,   80,   48,   61,   41,  -96,  127,
        -49,  -12,  -50,   63,  110,  125,  127,  -89,  -13,  127, -113,  127,
        5,  -65,  102, -124,  127,  114,  -73,  127, -128,  -35,   80,   92,
        -41,  -39,  -97,  127,  -78,  108,  105,  -31,  -39,  127,  104,  -41,
        -31,  -50,  127, -128,

        -113,  -80,  -42,  -43,  -69,   95,  127,  108,   29,  127,  -21,   44,
        104,  -96,  127,  -38,  -44,  101,   49,  -14,   95,  -57,   58,  -39,
        -100,   19,   19,   80, -128, -103,  120, -116,  -30,  -32,  -78, -110,
        -118,  -28,   11,  -44,   21,   32,  -99,  115,  127,  127, -100, -115,
        -15, -105,   47,   72,  -38,    8,  127, -116, -120,  -10,  -58,  -30,
        91,   -3,  122,  -24,

        101, -112,   30,  -19,  -37,  115,   24,   90,  -11,   40,   95,  -85,
        -110,   -6,  -48,  124,   88,   47,   14,   -8,   23,  -50,    0,   23,
        -44,  -98,  -69,  -70,  123,  -98,   -3,  -42, -125,  -55,    3,   10,
        119,  -73,   64,   63,   82,  -42,   89,   46,   19,  110,    2,  -31,
        -59,  -25,  -79,   -8,   97,   97,   32,  -41,  -63,   46,   39,  -60,
        63,   11,  121,  -56,

        32,  -43,  127,  -32,  100, -112,   45,  120,  -79, -109, -128,   -1,
        -125,    8,   77,  -27, -126,   10,  -61,   25,  -96,   10,   35,   89,
        29,   37,   32,   32,  -84, -128,  111,  112, -127,  -99,   29,  -97,
        72, -107,  127,  -68,  127,  127,  -20,   67,   78,  -75,   56,   92,
        61,   96,  -40,   -9,  -64,   81,   54,   90, -128, -128,   15,  -22,
        -73,  -37,   38,  -32,

        14, -107,    6, -118,  -88,    4,   -8,  -80,   33,   68,  -96,  -97,
        -102,  -74,   25,  -76,  -10,   34,  -35,   92,   98,   19,  -76,  -28,
        -15,  -16,  -46, -106,  120, -123,   84, -128,  -94,  -30,  110,   -2,
        49,   -5,   46, -116,   67,  -63,  117, -126,  124,  -18,  -79, -120,
        -109,   50,    8,   70,   22, -116,  -37, -111,   13,   63,   73, -123,
        -87,  -80, -106,  -72,

        82,  -20,  -11,  -77,    5,  107,   49,   -8,  -17,   88,   44,  -15,
        -17,   15,  -12,  107,   28,  -33,   25,   95,  -24,  -89,  -16, -116,
        -59,   30,  -45,   96,  -88,   23,  101,  114,   55,  115,  -58,   42,
        102,  107,   42,  -51,  -62,  -42,   68,  126,  -17,   87,   -2, -102,
        72,  -87,   65,    2,   23,  -92,  -46,   -8, -117,    8,   61,  -28,
        64,  -72,  121, -111,

        127,  127,  121,  -93,  127, -128,  127,   92,  -97, -128,  -81,  124,
        -127, -128, -128,   80, -128, -128,  -48, -104, -128, -128, -128, -111,
        19, -128, -128, -128,  -99,  124, -128,  -72,  -13,  -74, -128,  -70,
        127, -128,  127, -128, -128,  -88,   69,   96, -128,   -2,  127, -128,
        127, -128,   78, -128,  -57,  109,  127,   39,  127,   33,  -37,  122,
        127,   68,  -17, -128,

        -74,   25,  127,  123,  -83,  -11,  127,   16,   85,    4,  -69,  -68,
        -82, -127,   41,   85,  -41,   42,  126, -115,   48,  -39, -113,  100,
        8,   56,  -81,   47,   48,    7,  -64,   48, -117,   54,   18,  117,
        25,  -15,   22,   35,   34,  102,  122,  -26,  127,  104,  -46, -128,
        33,  112, -126,  -51,  110,  -95,  -99,   33,  -13,  -53,  -17,  -73,
        100, -116,  -11,  -81,

        114,  114, -106,  -86,  -93,   93,  -47,   56,  -29,  105,   96,   71,
        58,   -5,  126, -122,   98,  -65,  104,  114,  -50, -116,  -46,  -20,
        -11,  -70,   26,   -9,   74,   12, -113, -106,   49,  -13,  -16,  111,
        11,   54,  -54,   67,  119,  102,  -88,   17,  -69,    1,  -69,  -46,
        121,   21, -123,  -36,   48,  -43,  127,   86,  -17,  -10,   25,   79,
        35,   23,   23,  -23,

        -50, -118, -128,  125,   15, -128,  -37,   93,   69,  127,  -95,  -64,
        110,  118, -116, -128,  -65,   69,  127, -128, -128, -128,  -45,  127,
        -83,   49,  -93,   17,  -10,  -65, -128,  108, -128,   16,  -73,  -41,
        -30,   32,  127,   93,   32,  127,  119, -114,  110,   63,  -62,  127,
        127,  -41,  -78,  -23,   88,   77, -128,  127, -111, -128, -105,  127,
        -19,  -97,  127, -115,

        116,  -73,  -80,  -53, -128,   70, -103,  -25,    2,  127, -111, -128,
        -128,  -12,  -81,   88,  -88,   32,   50,  126,  107, -116,   59,  -81,
        11,   20, -128,  -43,  127, -108, -128,   77,   63,  127,  -29,   53,
        50,   94, -107,   34,  127,  -52,   50,  -33,   52,   98, -128,  -90,
        -81,   32, -128,  -20,  -66,  -24,  -58,  -67, -128,   73,  -87,   56,
        -28,  127,  -70, -121,

        9,   16,  -24,  -43,  -33,  -67,   10,  -12,   44,   98,    7,   -5,
        86, -108,   49,   -3,  -99,  -36,  -91,  -19, -108,   47,   32,   44,
        -7,   24,  -46,  -43,   58,   -2,   16,  -19,   66,   63,  -47,   79,
        47,   15,  105,   60,   71, -107,   79,   85,   88,  -17,   98,  -58,
        14,  110,    0,   77,   82,   -5,  -48,   96,  -24,  -24,   12,  -73,
        -2,  102,  109,  -89,

        -128, -117, -128, -128,  -82, -128, -109,  104, -124,   82,  127,  -55,
        115,  127,  117,   31,  127, -128, -103, -111,  -11, -128,  -18, -128,
        -61,  127,  127,   88,  127,   48,  -70,  -97,  -98,   36,  126, -106,
        42,  -33, -123, -128, -128,  106,   68, -128,  -73,  -18,  -61, -128,
        -43,   36,  -63,   77,  -75,   56,   26,  112,   86,    9,  -52,  -63,
        95, -123,  127,   58,

        90,  -89,  -53,  -62,    2,   93,  -49, -116,  -31,  -77,  -67, -100,
        80,   99,  -95,   73,   56,  -48,   99,  122,  127,   79,   56,  -18,
        9,   13,   41,  123,  -12,   -1, -128,  -11, -128,   50,  -79, -101,
        17,  -31,   52,    5,   27,  127,   61,  -10,  -99,   32,   21,  -67,
        49,   76,  -28,  116,  115,  -55, -128,   17,   91, -120, -102,   17,
        -98,  117,  -76,   27,

        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34,

        -128,  -71, -128,  127,   13,   -1,  -49,   71,   -2, -123,   67,   24,
        -43,   69,  108,   77,   47,   -4,  -15,  -92,  -39,  119,  100,  -66,
        -11,  -99,    1,  111,  100,  -67,   57, -128,  -33,  -16,   47,  -36,
        -88,  -52,  -78, -102,   93, -128,  -22,  104,  127, -117,    2,   80,
        -31,  -85,  -45,  127, -128, -113,  -81,   -2, -128,   81,  -50,   84,
        -55,   61,  -77,  -58,

        28,   -6,  -58,   79,   62,   11, -128,   87,   81, -121,  -85,  105,
        86,  -16,  -40,  108,  127,  -80,  -81,  -35,  100,  -81,  122,  127,
        107, -120,   95,   62,  -19,  -10,  100, -117,  100,  -10,    2,  -56,
        78,   57,   43, -105,   82,  -31,  -85,  102,  -83,  123,  116,   13,
        -7,  -23, -105,  122,    9,   -1,    1,  126,  127,  126,  127,   44,
        -105,  -81,   52,  -86,

        -61,   18,  127, -128,   20, -128,  -56,    4, -128,   18,  -69,   29,
        -95,  123, -128,   50,   56,   97, -128,  -77, -110,  -96,    6,  117,
        64, -103, -111,  -15,  -11,  -37,   73, -117,  103, -128,  127,   83,
        -122,  127,   80,  127, -128,  -36, -122,   61,   97,  127, -107,   71,
        -117,  -39, -128,    5,  114,  -92,  127,  127, -128,  -95,  127, -128,
        -68,  -92,   85,   57,

        32,  -57,  104, -119,  127, -128,    1,  -97,  -45, -102,   -6,   20,
        -100,  -27, -112, -112, -123,  -36,   51,   58,  -19,  109,   29,  113,
        56, -128,  -14,   68,   45,   92,  127,  127,   99,  -69,   19,  -76,
        -13,  107,  -83,  -14,   -4, -114,   36,  112,  -99,  117,    8,  -45,
        5,   40,  -75,   51,   86,   48,  105,   59,  113,  117,  -58, -124,
        -40,  -90,  -96,   38,

        -72,   26,   23,   87,  127,  127,   69,  127,   -8,  125,   47,    0,
        -82,   89, -113,  127,  -45,   17,    3,  114,  110,  114,  -26,  -62,
        -83,  120,  -77, -128,  -45,  -53,  -89,  -26,  -15,  -51, -128,   95,
        127,  127,   32,  -58,  -17,   21,   89,  104,  114, -128, -120,  127,
        -41,  127,   58,    4,  -85, -113, -114,  -90,   63,  -80, -128,   55,
        -77,   86,  -22,   74,

        127,  -41,  -83, -128,  127,   79,   58,  -92,   93, -128, -128,  105,
        -122, -124,  120,   -5,  -62,   65,  -56,  127,  -94,  127,  -92,   49,
        73,   28,   26,  -26,   65,  -89,   48,  127, -128,   35,   15,  -47,
        -74,  -77,   21, -128, -128,  106,   73,  -89,   67,  116, -124,   41,
        63, -128,   61,  104,  -15,   27,   76,   58, -128,  -98, -128,   45,
        127,  127, -128,  -37,

        -26, -118,  127,   15,  -16, -105,  -21,  -40,  -32,   68,  -71, -125,
        -80,   -4,  -76,   54,   91,   20,   31,   50,  124,  114,   54,  -46,
        -85,  -75,   21,  114,   10, -107, -128,   -5,  -84,   39, -128,  -88,
        45,  127,   22,  -16,  127,  -17,   35,  113, -120,   72,   54,  127,
        -63, -128, -128,  -77,  127,  127,  121,  -71,  -82,  -71,   42,   89,
        -88,  119,   56,  -93,

        62, -101,  -51,    2,   81, -113,  -62,   24,   33,  -34,  -46,  -71,
        -128,  -42,  -15,  127,   44,  -97,  -63,  127,   37,   75,  -89, -128,
        127,   99,  127,   43, -128,   81,  127, -128,  127,  -66, -128,  -91,
        -98, -124,  127,   76,   -4,  -56,  127, -112,   -9,  127, -112,  127,
        -114,  -50,   40,  103,  127,  127,  -32,   76,   27,   46,  -36,  -75,
        77,  127,   19,  127
    };
    float X_scale[24] = {
        0.0085, 0.0061, 0.0073, 0.0079, 0.0067, 0.0074, 0.0079, 0.0046, 0.0074, 0.0077,
        0.0056, 0.0058, 0.0086, 0.0051, 0.0073, 0.0068, 0.0071, 0.0068, 0.0059, 0.0066,
        0.0067, 0.0060, 0.0065, 0.0065
    };
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale[1] = {0.0164f};
    float O[384];
    for (int i = 0; i < 384; i++) {
        O[i] = 0.0f;
    }
    float expected_O[384] = {
        -0.32751, -0.860379, 0.134698, -1.51122, -0.686316, -0.794174, 0.0456554, -0.710866,
        0.513953, 0.451265, -1.04393, -0.405387, -0.412326, -0.0451973, 0.406947, -0.81619,
        0.184438, 0.348267, -0.40773, 1.22317, 0.272505, 0.475616, -0.955179, -0.123118, -0.250479,
        -0.448769, -0.358889, -0.328313, 0.871675, -0.648493, 0.325087, -0.61935,
        -0.114082, -0.173579, 0.782683, -0.386986, 0.479132, -0.21721, 0.635533, -0.398349,
        0.961082, -0.547002, 1.07752, -0.672141, 0.72637, 0.404673, -0.505057, -0.54519,
        -0.882915, 0.0807834, -0.611832, -0.000362335, 0.236161, -0.95259, 0.277764, -0.303415,
        0.23266, 0.583722, -0.0424994, -1.50855, -1.12271, -0.213993, -0.920017, -0.844027,
        -0.479779, -0.388866, -0.166552, -0.211928, -0.281142, 0.423207, 0.54662, 0.487937,
        0.127642, 0.63223, -0.032759, 0.250923, 0.453613, -0.404463, 0.56085, -0.234346,
        -0.267176, 0.529325, 0.254168, -0.121234, 0.404612, -0.28319, 0.32044, -0.22726,
        -0.41468, 0.103772, 0.100662, 0.424448, -0.70226, -0.486457, 0.560101, -0.532022,
        -0.202998, -0.200795, -0.32097, -0.561242, -0.57707, -0.126074, -0.00623055, -0.194739,
        0.0756797, 0.207852, -0.484259, 0.539414, 0.584813, 0.70423, -0.512302, -0.541568,
        -0.0589088, -0.531225, 0.229951, 0.372922, -0.196719, 0.103608, 0.667556, -0.500211,
        -0.531643, -0.0282003, -0.28755, -0.0991532, 0.37283, -0.0384498, 0.626721, -0.0996101,
        0.715836, 0.336983, 0.845109, -0.00664388, 0.209212, -0.0920555, 0.859445, -0.0732012,
        -0.343603, -0.0544728, -0.894128, -0.0348023, -0.396101, -1.25667, -0.858363, 0.501175,
        -0.289538, -0.763826, -0.499975, -0.409396, -0.574964, -0.555887, -0.297915, -0.797998, 0.104374, -0.425556, -0.381074, -0.912793, -0.599471, -0.0678525, -1.06442, 0.0349895,
        0.124207, -0.726707, -0.170409, -0.68783, 0.50367, -0.443274, 0.316848, -0.0475457,
        -0.967834, -0.828863, 0.52571, -0.226864, 0.11864, 0.0209037, 0.200918, -1.03906, 0.637762, -0.433581, 0.606689, -1.25304, 0.130528, -0.177622, -0.0268916, 0.129266, 0.500518, -0.504546, -0.488596, 0.467866, 0.884753, 0.464907, -0.622268, -0.208384,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0
    };

    sparse::quantized_grouped_sparse_conv2d_vectorized_forward_stride_2(
        B, IC, OC, M, N, K, 8, 0,
        X, X_scale, 64, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, 64, O
    );

    for (int i = 0; i < 384; i++) {
        ASSERT_THAT(O[i], testing::FloatNear(expected_O[i], 0.3f));
    }
}


TEST(Test_Sparse, QuantizeGroupedSparseConv2dBackward1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        97,    1,   19,   94,   59,  117,  -20,   -5,  -73,  -32,   71,  -48,
        -98, -105,  -86,   16,  -96,  -35,   51,  -94,   78,  -29,   95,   26,
        49,   20,    2,  -59,   10,  -11,  107,  -10,  -75,  -33,    6,   48,
        -32,   75,  -92,  -89, -100,  -20,  -37,   -3,   -6,  -65,   -8,  -77,
        25,   68,  108,  117,   14,   45,  -70,  -76,   12,   14,   92,   84,
        88, -103,    0,   81,

        -88,   26, -128,  -80,   54, -128,  -13,  120,   13, -112,  127,   99,
        17,  127,   86,  -33,  -82,   50,   80,   48,   61,   41,  -96,  127,
        -49,  -12,  -50,   63,  110,  125,  127,  -89,  -13,  127, -113,  127,
        5,  -65,  102, -124,  127,  114,  -73,  127, -128,  -35,   80,   92,
        -41,  -39,  -97,  127,  -78,  108,  105,  -31,  -39,  127,  104,  -41,
        -31,  -50,  127, -128,

        -113,  -80,  -42,  -43,  -69,   95,  127,  108,   29,  127,  -21,   44,
        104,  -96,  127,  -38,  -44,  101,   49,  -14,   95,  -57,   58,  -39,
        -100,   19,   19,   80, -128, -103,  120, -116,  -30,  -32,  -78, -110,
        -118,  -28,   11,  -44,   21,   32,  -99,  115,  127,  127, -100, -115,
        -15, -105,   47,   72,  -38,    8,  127, -116, -120,  -10,  -58,  -30,
        91,   -3,  122,  -24,

        101, -112,   30,  -19,  -37,  115,   24,   90,  -11,   40,   95,  -85,
        -110,   -6,  -48,  124,   88,   47,   14,   -8,   23,  -50,    0,   23,
        -44,  -98,  -69,  -70,  123,  -98,   -3,  -42, -125,  -55,    3,   10,
        119,  -73,   64,   63,   82,  -42,   89,   46,   19,  110,    2,  -31,
        -59,  -25,  -79,   -8,   97,   97,   32,  -41,  -63,   46,   39,  -60,
        63,   11,  121,  -56,

        32,  -43,  127,  -32,  100, -112,   45,  120,  -79, -109, -128,   -1,
        -125,    8,   77,  -27, -126,   10,  -61,   25,  -96,   10,   35,   89,
        29,   37,   32,   32,  -84, -128,  111,  112, -127,  -99,   29,  -97,
        72, -107,  127,  -68,  127,  127,  -20,   67,   78,  -75,   56,   92,
        61,   96,  -40,   -9,  -64,   81,   54,   90, -128, -128,   15,  -22,
        -73,  -37,   38,  -32,

        14, -107,    6, -118,  -88,    4,   -8,  -80,   33,   68,  -96,  -97,
        -102,  -74,   25,  -76,  -10,   34,  -35,   92,   98,   19,  -76,  -28,
        -15,  -16,  -46, -106,  120, -123,   84, -128,  -94,  -30,  110,   -2,
        49,   -5,   46, -116,   67,  -63,  117, -126,  124,  -18,  -79, -120,
        -109,   50,    8,   70,   22, -116,  -37, -111,   13,   63,   73, -123,
        -87,  -80, -106,  -72,

        82,  -20,  -11,  -77,    5,  107,   49,   -8,  -17,   88,   44,  -15,
        -17,   15,  -12,  107,   28,  -33,   25,   95,  -24,  -89,  -16, -116,
        -59,   30,  -45,   96,  -88,   23,  101,  114,   55,  115,  -58,   42,
        102,  107,   42,  -51,  -62,  -42,   68,  126,  -17,   87,   -2, -102,
        72,  -87,   65,    2,   23,  -92,  -46,   -8, -117,    8,   61,  -28,
        64,  -72,  121, -111,

        127,  127,  121,  -93,  127, -128,  127,   92,  -97, -128,  -81,  124,
        -127, -128, -128,   80, -128, -128,  -48, -104, -128, -128, -128, -111,
        19, -128, -128, -128,  -99,  124, -128,  -72,  -13,  -74, -128,  -70,
        127, -128,  127, -128, -128,  -88,   69,   96, -128,   -2,  127, -128,
        127, -128,   78, -128,  -57,  109,  127,   39,  127,   33,  -37,  122,
        127,   68,  -17, -128,

        -74,   25,  127,  123,  -83,  -11,  127,   16,   85,    4,  -69,  -68,
        -82, -127,   41,   85,  -41,   42,  126, -115,   48,  -39, -113,  100,
        8,   56,  -81,   47,   48,    7,  -64,   48, -117,   54,   18,  117,
        25,  -15,   22,   35,   34,  102,  122,  -26,  127,  104,  -46, -128,
        33,  112, -126,  -51,  110,  -95,  -99,   33,  -13,  -53,  -17,  -73,
        100, -116,  -11,  -81,

        114,  114, -106,  -86,  -93,   93,  -47,   56,  -29,  105,   96,   71,
        58,   -5,  126, -122,   98,  -65,  104,  114,  -50, -116,  -46,  -20,
        -11,  -70,   26,   -9,   74,   12, -113, -106,   49,  -13,  -16,  111,
        11,   54,  -54,   67,  119,  102,  -88,   17,  -69,    1,  -69,  -46,
        121,   21, -123,  -36,   48,  -43,  127,   86,  -17,  -10,   25,   79,
        35,   23,   23,  -23,

        -50, -118, -128,  125,   15, -128,  -37,   93,   69,  127,  -95,  -64,
        110,  118, -116, -128,  -65,   69,  127, -128, -128, -128,  -45,  127,
        -83,   49,  -93,   17,  -10,  -65, -128,  108, -128,   16,  -73,  -41,
        -30,   32,  127,   93,   32,  127,  119, -114,  110,   63,  -62,  127,
        127,  -41,  -78,  -23,   88,   77, -128,  127, -111, -128, -105,  127,
        -19,  -97,  127, -115,

        116,  -73,  -80,  -53, -128,   70, -103,  -25,    2,  127, -111, -128,
        -128,  -12,  -81,   88,  -88,   32,   50,  126,  107, -116,   59,  -81,
        11,   20, -128,  -43,  127, -108, -128,   77,   63,  127,  -29,   53,
        50,   94, -107,   34,  127,  -52,   50,  -33,   52,   98, -128,  -90,
        -81,   32, -128,  -20,  -66,  -24,  -58,  -67, -128,   73,  -87,   56,
        -28,  127,  -70, -121,

        9,   16,  -24,  -43,  -33,  -67,   10,  -12,   44,   98,    7,   -5,
        86, -108,   49,   -3,  -99,  -36,  -91,  -19, -108,   47,   32,   44,
        -7,   24,  -46,  -43,   58,   -2,   16,  -19,   66,   63,  -47,   79,
        47,   15,  105,   60,   71, -107,   79,   85,   88,  -17,   98,  -58,
        14,  110,    0,   77,   82,   -5,  -48,   96,  -24,  -24,   12,  -73,
        -2,  102,  109,  -89,

        -128, -117, -128, -128,  -82, -128, -109,  104, -124,   82,  127,  -55,
        115,  127,  117,   31,  127, -128, -103, -111,  -11, -128,  -18, -128,
        -61,  127,  127,   88,  127,   48,  -70,  -97,  -98,   36,  126, -106,
        42,  -33, -123, -128, -128,  106,   68, -128,  -73,  -18,  -61, -128,
        -43,   36,  -63,   77,  -75,   56,   26,  112,   86,    9,  -52,  -63,
        95, -123,  127,   58,

        90,  -89,  -53,  -62,    2,   93,  -49, -116,  -31,  -77,  -67, -100,
        80,   99,  -95,   73,   56,  -48,   99,  122,  127,   79,   56,  -18,
        9,   13,   41,  123,  -12,   -1, -128,  -11, -128,   50,  -79, -101,
        17,  -31,   52,    5,   27,  127,   61,  -10,  -99,   32,   21,  -67,
        49,   76,  -28,  116,  115,  -55, -128,   17,   91, -120, -102,   17,
        -98,  117,  -76,   27,

        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34,

        -128,  -71, -128,  127,   13,   -1,  -49,   71,   -2, -123,   67,   24,
        -43,   69,  108,   77,   47,   -4,  -15,  -92,  -39,  119,  100,  -66,
        -11,  -99,    1,  111,  100,  -67,   57, -128,  -33,  -16,   47,  -36,
        -88,  -52,  -78, -102,   93, -128,  -22,  104,  127, -117,    2,   80,
        -31,  -85,  -45,  127, -128, -113,  -81,   -2, -128,   81,  -50,   84,
        -55,   61,  -77,  -58,

        28,   -6,  -58,   79,   62,   11, -128,   87,   81, -121,  -85,  105,
        86,  -16,  -40,  108,  127,  -80,  -81,  -35,  100,  -81,  122,  127,
        107, -120,   95,   62,  -19,  -10,  100, -117,  100,  -10,    2,  -56,
        78,   57,   43, -105,   82,  -31,  -85,  102,  -83,  123,  116,   13,
        -7,  -23, -105,  122,    9,   -1,    1,  126,  127,  126,  127,   44,
        -105,  -81,   52,  -86,

        -61,   18,  127, -128,   20, -128,  -56,    4, -128,   18,  -69,   29,
        -95,  123, -128,   50,   56,   97, -128,  -77, -110,  -96,    6,  117,
        64, -103, -111,  -15,  -11,  -37,   73, -117,  103, -128,  127,   83,
        -122,  127,   80,  127, -128,  -36, -122,   61,   97,  127, -107,   71,
        -117,  -39, -128,    5,  114,  -92,  127,  127, -128,  -95,  127, -128,
        -68,  -92,   85,   57,

        32,  -57,  104, -119,  127, -128,    1,  -97,  -45, -102,   -6,   20,
        -100,  -27, -112, -112, -123,  -36,   51,   58,  -19,  109,   29,  113,
        56, -128,  -14,   68,   45,   92,  127,  127,   99,  -69,   19,  -76,
        -13,  107,  -83,  -14,   -4, -114,   36,  112,  -99,  117,    8,  -45,
        5,   40,  -75,   51,   86,   48,  105,   59,  113,  117,  -58, -124,
        -40,  -90,  -96,   38,

        -72,   26,   23,   87,  127,  127,   69,  127,   -8,  125,   47,    0,
        -82,   89, -113,  127,  -45,   17,    3,  114,  110,  114,  -26,  -62,
        -83,  120,  -77, -128,  -45,  -53,  -89,  -26,  -15,  -51, -128,   95,
        127,  127,   32,  -58,  -17,   21,   89,  104,  114, -128, -120,  127,
        -41,  127,   58,    4,  -85, -113, -114,  -90,   63,  -80, -128,   55,
        -77,   86,  -22,   74,

        127,  -41,  -83, -128,  127,   79,   58,  -92,   93, -128, -128,  105,
        -122, -124,  120,   -5,  -62,   65,  -56,  127,  -94,  127,  -92,   49,
        73,   28,   26,  -26,   65,  -89,   48,  127, -128,   35,   15,  -47,
        -74,  -77,   21, -128, -128,  106,   73,  -89,   67,  116, -124,   41,
        63, -128,   61,  104,  -15,   27,   76,   58, -128,  -98, -128,   45,
        127,  127, -128,  -37,

        -26, -118,  127,   15,  -16, -105,  -21,  -40,  -32,   68,  -71, -125,
        -80,   -4,  -76,   54,   91,   20,   31,   50,  124,  114,   54,  -46,
        -85,  -75,   21,  114,   10, -107, -128,   -5,  -84,   39, -128,  -88,
        45,  127,   22,  -16,  127,  -17,   35,  113, -120,   72,   54,  127,
        -63, -128, -128,  -77,  127,  127,  121,  -71,  -82,  -71,   42,   89,
        -88,  119,   56,  -93,

        62, -101,  -51,    2,   81, -113,  -62,   24,   33,  -34,  -46,  -71,
        -128,  -42,  -15,  127,   44,  -97,  -63,  127,   37,   75,  -89, -128,
        127,   99,  127,   43, -128,   81,  127, -128,  127,  -66, -128,  -91,
        -98, -124,  127,   76,   -4,  -56,  127, -112,   -9,  127, -112,  127,
        -114,  -50,   40,  103,  127,  127,  -32,   76,   27,   46,  -36,  -75,
        77,  127,   19,  127
    };
    float X_scale[24] = {
        0.0085, 0.0061, 0.0073, 0.0079, 0.0067, 0.0074, 0.0079, 0.0046, 0.0074, 0.0077,
        0.0056, 0.0058, 0.0086, 0.0051, 0.0073, 0.0068, 0.0071, 0.0068, 0.0059, 0.0066,
        0.0067, 0.0060, 0.0065, 0.0065
    };
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale[1] = {0.0164f};
    int8_t dLdO[384] = {
        -6, -36, -16, -25,  34,  -5,  -6,  10,  15,  12,  43, -43, -51,  50,
        -49, -32,  44,  22,  39, -27,  31,  53,   6,  12,  34, -10, -17, -52,
        -56,   5,  19, -31, -36, -44, -55,  22,  50,  11,  23, -34,   3, -20,
        -18,  40,  -7, -29, -54,   8, -57,  47,  26, -50,  10, -12,  19,  58,
        41, -21,  58,  -5,  -1,   1, -45,  23,

        16,  37,  15,  -4, -11,  27, -22, -39, -55,  23, -16, -48,  40,  12,
        8,   7, -31,  48,   4,   8, -24, -15,  30, -14,  -5,  -3,  64,  26,
        8,  31, -36,  44, -18, -52,  64, -36,  26,  36,  37, -51,  49,  47,
        -2, -18,  52, -24, -63,  35,  58, -19,  62,  53,   2, -10, -11,   7,
        -6, -46,  32,  23, -11,  33, -51,  10,

        18,  13,   1,   9,  55,  12,  49, -10, -29,   5,  -4,  26,  12,  24,
        34,  27,  -5,  36,  -1,  36,  44,  41, -58, -27,  44, -23,  39,  58,
        -10,  26,  43,  13,  30,  53,  14, -16, -17, -31,   9,  40,  58, -12,
        28, -45,  42,  59, -54,  49, -51, -52,  23,  -2, -34,  -7, -60,  33,
        -30,  58,  49,  50, -31,   2,  32,  41,

        -43,  20,  32, -50,  36,  14, -22,  35,  -8,   4,  13, -26, -32,  -4,
        34,  23, -31, -27, -27, -30, -39, -20, -22,  54,  13,  12, -15, -37,
        30, -46, -37,  20,  -5,  42,  45,  53,  -9, -27, -59,  22,  29,  16,
        47, -39, -25,  20,  51, -54, -29, -49, -31, -41,  28, -58,  41,  -4,
        54, -34, -36, -14, -42,  -4, -36,  36,

        26,  23,  51,  -5, -38, -44,   2,  43, -37,  -9,  42, -50, -10,  44,
        -25, -53,  56, -28, -12,  -3, -23, -33,  18,  52, -22, -48,  42,  -2,
        31,  44,  17,  12, -54,  38,  -4,   5, -24,  38,  24, -32, -22, -47,
        30, -49, -36,  28, -24,  42, -19,   0, -25,   2, -24,  12,  46, -44,
        -12,  51, -45,  26, -36,  56,  10,   0,

        -56,  55,  27, -23,  49,   5, -51, -11, -24,  -3, -29,  34, -56,  54,
        -52,  13, -43,  41, -42, -22, -39, -35,  19,  -3,  51,  -1, -26, -29,
        -20, -58,  44,  20, -49, -10, -30,  14,   5, -50,  22,   5, -25,  28,
        3, -30,  57,   7, -19, -31,  18, -16,  39,  -8, -45, -57,  -1,   9,
        16, -36, -33, -40,  53, -53,  22,  14
    };
    float dLdO_scale[6] = {0.0172f, 0.0152f, 0.0164f, 0.0171f, 0.0173f, 0.0173f};
    float dLdX[1536];
    for (int i = 0; i < 1536; i++) {
        dLdX[i] = 0.0f;
    }
    float expected_dLdX[1536] = {
        0.0630055, 0.359686, 0.167985, 0.253749, -0.334338, 0.0506311, 0.0634343, -0.0967107, -0.159064, -0.124919, -0.428964, 0.426621, 0.513312, -0.505313, 0.503516, 0.32473,
        -0.445297, -0.217289, -0.394454, 0.27989, -0.309442, -0.541303, -0.0653489, -0.12439, -0.348574, 0.100434, 0.171368, 0.52134, 0.564342, -0.0495487, -0.192, 0.312514,
        0.363298, 0.447505, 0.550512, -0.221882, -0.509213, -0.114835, -0.227602, 0.342184, -0.0271033, 0.200457, 0.17804, -0.404227, 0.0733831, 0.288822, 0.545837, -0.0748338,
        0.567731, -0.479718, -0.259269, 0.499675, -0.100387, 0.11665, -0.199482, -0.583318, -0.41222, 0.209449, -0.58195, 0.0554593, 0.00677979, -0.00476987, 0.454652, -0.23065,
        -0.181716, -0.136715, -0.0123592, -0.0951821, -0.546108, -0.115703, -0.488166, 0.0906274, 0.290198, -0.0461244, 0.0314502, -0.259481, -0.119675, -0.240722, -0.335885, -0.265372,
        0.0510654, -0.359746, 0.00616409, -0.358781, -0.434693, -0.406861, 0.581654, 0.261297, -0.441641, 0.221282, -0.382405, -0.580178, 0.100812, -0.264261, -0.426057, -0.125426,
        -0.294984, -0.52809, -0.136813, 0.164597, 0.161026, 0.309753, -0.0943198, -0.404589, -0.584405, 0.120124, -0.277032, 0.44676, -0.419529, -0.589792, 0.535377, -0.483599,
        0.512622, 0.52178, -0.225296, 0.0169358, 0.339517, 0.0757364, 0.594771, -0.330037, 0.292852, -0.577032, -0.4827, -0.494269, 0.304361, -0.0236628, -0.323181, -0.406472,
        0.157451, 0.368028, 0.15185, -0.0380259, -0.112725, 0.26855, -0.217765, -0.383781, -0.547967, 0.231347, -0.160737, -0.473619, 0.399822, 0.120798, 0.080283, 0.0664784,
        -0.315177, 0.480577, 0.0400077, 0.0810503, -0.235524, -0.154611, 0.300796, -0.132714, -0.049587, -0.0355791, 0.641517, 0.265219, 0.0778369, 0.299812, -0.36107, 0.434586,
        -0.177322, -0.51397, 0.630643, -0.363071, 0.258838, 0.361405, 0.369314, -0.510291, 0.486748, 0.466956, -0.0135462, -0.174633, 0.511321, -0.240875, -0.625423, 0.349732,
        0.573563, -0.182673, 0.614327, 0.521905, 0.0251335, -0.0930318, -0.105676, 0.0688656, -0.0567687, -0.453059, 0.317184, 0.225982, -0.114181, 0.33251, -0.501228, 0.102751,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.101948, -0.582002, -0.271814, -0.410587, 0.540987, -0.0819254, -0.102642, 0.156486, 0.257379, 0.202129, 0.694099, -0.690307, -0.830581, 0.817638, -0.81473, -0.52544,
        0.720527, 0.351592, 0.638259, -0.452884, 0.500704, 0.875872, 0.10574, 0.201274, 0.564022, -0.162511, -0.277288, -0.843572, -0.913153, 0.080174, 0.310672, -0.505674,
        -0.587846, -0.7241, -0.890773, 0.359023, 0.823948, 0.185812, 0.368279, -0.553683, 0.0438554, -0.324356, -0.288083, 0.654072, -0.11874, -0.467339, -0.883209, 0.121087,
        -0.918636, 0.776224, 0.419519, -0.808515, 0.162435, -0.188749, 0.322779, 0.943857, 0.667006, -0.338905, 0.941643, -0.0897378, -0.0109703, 0.00771805, -0.735665, 0.373211,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.217234, 0.163437, 0.0147748, 0.113786, 0.652848, 0.138318, 0.583581, -0.108341, -0.346919, 0.0551397, -0.0375974, 0.310198, 0.143066, 0.287772, 0.401536, 0.31724,
        -0.0610464, 0.430061, -0.0073689, 0.428906, 0.519656, 0.486384, -0.695341, -0.312369, 0.527962, -0.264533, 0.457148, 0.693577, -0.120516, 0.315912, 0.509333, 0.149941,
        0.35264, 0.631308, 0.163553, -0.196768, -0.192499, -0.370296, 0.112755, 0.483668, 0.69863, -0.143603, 0.331179, -0.534082, 0.501528, 0.705069, -0.64002, 0.578121,
        -0.612817, -0.623765, 0.269331, -0.020246, -0.405878, -0.0905395, -0.711023, 0.394545, -0.350092, 0.689816, 0.577047, 0.590877, -0.363849, 0.0282879, 0.386348, 0.485919,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.0255717, -0.00610609, -0.0125945, 0.0256315, 0.136352, -0.000809473, 0.133767, 0.0182469, -0.0107244, -0.012945, 0.00913045, 0.107446, -0.0132324, 0.0427895, 0.0686696, 0.0539439,
        0.0203284, 0.033475, -0.00547283, 0.0738283, 0.123341, 0.108758, -0.163582, -0.0462853, 0.106047, -0.0469977, 0.0223131, 0.105762, -0.0309622, 0.0299934, 0.134115, -0.0154475,
        0.0854759, 0.17298, -0.0327538, -0.00077431, -0.0631157, -0.107549, -0.0159332, 0.144359, 0.0842316, -0.0748963, 0.0647377, -0.0844469, 0.0440262, 0.159358, -0.058935, 0.0750903,
        -0.175494, -0.100789, -0.0108591, -0.0568758, -0.0802059, -0.00787434, -0.125303, 0.0684915, -0.0612152, 0.177988, 0.0781901, 0.0900982, -0.0580168, -0.0283561, 0.124819, 0.0825323,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.0290192, -0.165665, -0.0773711, -0.116872, 0.15399, -0.0233198, -0.0292167, 0.0445432, 0.0732622, 0.0575354, 0.197573, -0.196494, -0.236422, 0.232738, -0.23191, -0.149565,
        0.205096, 0.10008, 0.181679, -0.128912, 0.142524, 0.249314, 0.0300985, 0.0572919, 0.160547, -0.0462582, -0.0789292, -0.24012, -0.259926, 0.0228213, 0.0884319, -0.143938,
        -0.167329, -0.206113, -0.253556, 0.102195, 0.234534, 0.0528909, 0.10483, -0.157604, 0.0124833, -0.0923271, -0.0820021, 0.18618, -0.033799, -0.133026, -0.251403, 0.0344671,
        -0.261487, 0.22095, 0.119415, -0.230141, 0.0462366, -0.0537267, 0.091878, 0.268666, 0.189861, -0.0964684, 0.268036, -0.0255436, -0.00312265, 0.00219692, -0.209405, 0.106233,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };
    float dLdW_val[8] = {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f};
    float expected_dLdW_val[8] = {
        2.86988, 2.6798, 2.35642, -0.574233, -2.91686, 2.39239, -4.51477, -1.17145
    };

    sparse::quantized_grouped_sparse_conv2d_vectorized_backward_stride_2(
        B, IC, OC, M, N, K, 8, 0, X, X_scale, 64, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, 64, dLdO, dLdO_scale, 64, dLdX, dLdW_val
    );

    for (int i = 0; i < 1536; i++) {
        ASSERT_THAT(dLdX[i], testing::FloatNear(expected_dLdX[i], 0.025f));
    }

    for (int i = 0; i < 8; i++) {
        ASSERT_THAT(dLdW_val[i], testing::FloatNear(expected_dLdW_val[i], std::abs(expected_dLdW_val[i]) * 0.35));
    }
}


TEST(Test_Sparse, QuantizeGroupedSparseConv2dBackwardParallel1Stride2) {
    int B = 64;
    int IC = 2;
    int OC = 3;
    int M = 4;
    int N = 3;
    int K = 3;
    int8_t X[1536] = {
        97,    1,   19,   94,   59,  117,  -20,   -5,  -73,  -32,   71,  -48,
        -98, -105,  -86,   16,  -96,  -35,   51,  -94,   78,  -29,   95,   26,
        49,   20,    2,  -59,   10,  -11,  107,  -10,  -75,  -33,    6,   48,
        -32,   75,  -92,  -89, -100,  -20,  -37,   -3,   -6,  -65,   -8,  -77,
        25,   68,  108,  117,   14,   45,  -70,  -76,   12,   14,   92,   84,
        88, -103,    0,   81,

        -88,   26, -128,  -80,   54, -128,  -13,  120,   13, -112,  127,   99,
        17,  127,   86,  -33,  -82,   50,   80,   48,   61,   41,  -96,  127,
        -49,  -12,  -50,   63,  110,  125,  127,  -89,  -13,  127, -113,  127,
        5,  -65,  102, -124,  127,  114,  -73,  127, -128,  -35,   80,   92,
        -41,  -39,  -97,  127,  -78,  108,  105,  -31,  -39,  127,  104,  -41,
        -31,  -50,  127, -128,

        -113,  -80,  -42,  -43,  -69,   95,  127,  108,   29,  127,  -21,   44,
        104,  -96,  127,  -38,  -44,  101,   49,  -14,   95,  -57,   58,  -39,
        -100,   19,   19,   80, -128, -103,  120, -116,  -30,  -32,  -78, -110,
        -118,  -28,   11,  -44,   21,   32,  -99,  115,  127,  127, -100, -115,
        -15, -105,   47,   72,  -38,    8,  127, -116, -120,  -10,  -58,  -30,
        91,   -3,  122,  -24,

        101, -112,   30,  -19,  -37,  115,   24,   90,  -11,   40,   95,  -85,
        -110,   -6,  -48,  124,   88,   47,   14,   -8,   23,  -50,    0,   23,
        -44,  -98,  -69,  -70,  123,  -98,   -3,  -42, -125,  -55,    3,   10,
        119,  -73,   64,   63,   82,  -42,   89,   46,   19,  110,    2,  -31,
        -59,  -25,  -79,   -8,   97,   97,   32,  -41,  -63,   46,   39,  -60,
        63,   11,  121,  -56,

        32,  -43,  127,  -32,  100, -112,   45,  120,  -79, -109, -128,   -1,
        -125,    8,   77,  -27, -126,   10,  -61,   25,  -96,   10,   35,   89,
        29,   37,   32,   32,  -84, -128,  111,  112, -127,  -99,   29,  -97,
        72, -107,  127,  -68,  127,  127,  -20,   67,   78,  -75,   56,   92,
        61,   96,  -40,   -9,  -64,   81,   54,   90, -128, -128,   15,  -22,
        -73,  -37,   38,  -32,

        14, -107,    6, -118,  -88,    4,   -8,  -80,   33,   68,  -96,  -97,
        -102,  -74,   25,  -76,  -10,   34,  -35,   92,   98,   19,  -76,  -28,
        -15,  -16,  -46, -106,  120, -123,   84, -128,  -94,  -30,  110,   -2,
        49,   -5,   46, -116,   67,  -63,  117, -126,  124,  -18,  -79, -120,
        -109,   50,    8,   70,   22, -116,  -37, -111,   13,   63,   73, -123,
        -87,  -80, -106,  -72,

        82,  -20,  -11,  -77,    5,  107,   49,   -8,  -17,   88,   44,  -15,
        -17,   15,  -12,  107,   28,  -33,   25,   95,  -24,  -89,  -16, -116,
        -59,   30,  -45,   96,  -88,   23,  101,  114,   55,  115,  -58,   42,
        102,  107,   42,  -51,  -62,  -42,   68,  126,  -17,   87,   -2, -102,
        72,  -87,   65,    2,   23,  -92,  -46,   -8, -117,    8,   61,  -28,
        64,  -72,  121, -111,

        127,  127,  121,  -93,  127, -128,  127,   92,  -97, -128,  -81,  124,
        -127, -128, -128,   80, -128, -128,  -48, -104, -128, -128, -128, -111,
        19, -128, -128, -128,  -99,  124, -128,  -72,  -13,  -74, -128,  -70,
        127, -128,  127, -128, -128,  -88,   69,   96, -128,   -2,  127, -128,
        127, -128,   78, -128,  -57,  109,  127,   39,  127,   33,  -37,  122,
        127,   68,  -17, -128,

        -74,   25,  127,  123,  -83,  -11,  127,   16,   85,    4,  -69,  -68,
        -82, -127,   41,   85,  -41,   42,  126, -115,   48,  -39, -113,  100,
        8,   56,  -81,   47,   48,    7,  -64,   48, -117,   54,   18,  117,
        25,  -15,   22,   35,   34,  102,  122,  -26,  127,  104,  -46, -128,
        33,  112, -126,  -51,  110,  -95,  -99,   33,  -13,  -53,  -17,  -73,
        100, -116,  -11,  -81,

        114,  114, -106,  -86,  -93,   93,  -47,   56,  -29,  105,   96,   71,
        58,   -5,  126, -122,   98,  -65,  104,  114,  -50, -116,  -46,  -20,
        -11,  -70,   26,   -9,   74,   12, -113, -106,   49,  -13,  -16,  111,
        11,   54,  -54,   67,  119,  102,  -88,   17,  -69,    1,  -69,  -46,
        121,   21, -123,  -36,   48,  -43,  127,   86,  -17,  -10,   25,   79,
        35,   23,   23,  -23,

        -50, -118, -128,  125,   15, -128,  -37,   93,   69,  127,  -95,  -64,
        110,  118, -116, -128,  -65,   69,  127, -128, -128, -128,  -45,  127,
        -83,   49,  -93,   17,  -10,  -65, -128,  108, -128,   16,  -73,  -41,
        -30,   32,  127,   93,   32,  127,  119, -114,  110,   63,  -62,  127,
        127,  -41,  -78,  -23,   88,   77, -128,  127, -111, -128, -105,  127,
        -19,  -97,  127, -115,

        116,  -73,  -80,  -53, -128,   70, -103,  -25,    2,  127, -111, -128,
        -128,  -12,  -81,   88,  -88,   32,   50,  126,  107, -116,   59,  -81,
        11,   20, -128,  -43,  127, -108, -128,   77,   63,  127,  -29,   53,
        50,   94, -107,   34,  127,  -52,   50,  -33,   52,   98, -128,  -90,
        -81,   32, -128,  -20,  -66,  -24,  -58,  -67, -128,   73,  -87,   56,
        -28,  127,  -70, -121,

        9,   16,  -24,  -43,  -33,  -67,   10,  -12,   44,   98,    7,   -5,
        86, -108,   49,   -3,  -99,  -36,  -91,  -19, -108,   47,   32,   44,
        -7,   24,  -46,  -43,   58,   -2,   16,  -19,   66,   63,  -47,   79,
        47,   15,  105,   60,   71, -107,   79,   85,   88,  -17,   98,  -58,
        14,  110,    0,   77,   82,   -5,  -48,   96,  -24,  -24,   12,  -73,
        -2,  102,  109,  -89,

        -128, -117, -128, -128,  -82, -128, -109,  104, -124,   82,  127,  -55,
        115,  127,  117,   31,  127, -128, -103, -111,  -11, -128,  -18, -128,
        -61,  127,  127,   88,  127,   48,  -70,  -97,  -98,   36,  126, -106,
        42,  -33, -123, -128, -128,  106,   68, -128,  -73,  -18,  -61, -128,
        -43,   36,  -63,   77,  -75,   56,   26,  112,   86,    9,  -52,  -63,
        95, -123,  127,   58,

        90,  -89,  -53,  -62,    2,   93,  -49, -116,  -31,  -77,  -67, -100,
        80,   99,  -95,   73,   56,  -48,   99,  122,  127,   79,   56,  -18,
        9,   13,   41,  123,  -12,   -1, -128,  -11, -128,   50,  -79, -101,
        17,  -31,   52,    5,   27,  127,   61,  -10,  -99,   32,   21,  -67,
        49,   76,  -28,  116,  115,  -55, -128,   17,   91, -120, -102,   17,
        -98,  117,  -76,   27,

        -128,    8,  -78,   10, -107,   66,  127,   67,   29,   50, -128,  -85,
        96, -123,  122,  118,  123, -100,  -43,  122,  108,   23,  -88,   84,
        -128,  -33,  -24,  -91,  127,  -17,   29,  -56,  126,  103, -114,   71,
        25,  -16,  127,  -31,   60, -118,   25,   28,   91, -108,   73,  -19,
        -33,   63,  -15,  -62,   30, -128, -108, -119,  -96,  -39,   23,  -99,
        127,   57,  -95,  -34,

        -128,  -71, -128,  127,   13,   -1,  -49,   71,   -2, -123,   67,   24,
        -43,   69,  108,   77,   47,   -4,  -15,  -92,  -39,  119,  100,  -66,
        -11,  -99,    1,  111,  100,  -67,   57, -128,  -33,  -16,   47,  -36,
        -88,  -52,  -78, -102,   93, -128,  -22,  104,  127, -117,    2,   80,
        -31,  -85,  -45,  127, -128, -113,  -81,   -2, -128,   81,  -50,   84,
        -55,   61,  -77,  -58,

        28,   -6,  -58,   79,   62,   11, -128,   87,   81, -121,  -85,  105,
        86,  -16,  -40,  108,  127,  -80,  -81,  -35,  100,  -81,  122,  127,
        107, -120,   95,   62,  -19,  -10,  100, -117,  100,  -10,    2,  -56,
        78,   57,   43, -105,   82,  -31,  -85,  102,  -83,  123,  116,   13,
        -7,  -23, -105,  122,    9,   -1,    1,  126,  127,  126,  127,   44,
        -105,  -81,   52,  -86,

        -61,   18,  127, -128,   20, -128,  -56,    4, -128,   18,  -69,   29,
        -95,  123, -128,   50,   56,   97, -128,  -77, -110,  -96,    6,  117,
        64, -103, -111,  -15,  -11,  -37,   73, -117,  103, -128,  127,   83,
        -122,  127,   80,  127, -128,  -36, -122,   61,   97,  127, -107,   71,
        -117,  -39, -128,    5,  114,  -92,  127,  127, -128,  -95,  127, -128,
        -68,  -92,   85,   57,

        32,  -57,  104, -119,  127, -128,    1,  -97,  -45, -102,   -6,   20,
        -100,  -27, -112, -112, -123,  -36,   51,   58,  -19,  109,   29,  113,
        56, -128,  -14,   68,   45,   92,  127,  127,   99,  -69,   19,  -76,
        -13,  107,  -83,  -14,   -4, -114,   36,  112,  -99,  117,    8,  -45,
        5,   40,  -75,   51,   86,   48,  105,   59,  113,  117,  -58, -124,
        -40,  -90,  -96,   38,

        -72,   26,   23,   87,  127,  127,   69,  127,   -8,  125,   47,    0,
        -82,   89, -113,  127,  -45,   17,    3,  114,  110,  114,  -26,  -62,
        -83,  120,  -77, -128,  -45,  -53,  -89,  -26,  -15,  -51, -128,   95,
        127,  127,   32,  -58,  -17,   21,   89,  104,  114, -128, -120,  127,
        -41,  127,   58,    4,  -85, -113, -114,  -90,   63,  -80, -128,   55,
        -77,   86,  -22,   74,

        127,  -41,  -83, -128,  127,   79,   58,  -92,   93, -128, -128,  105,
        -122, -124,  120,   -5,  -62,   65,  -56,  127,  -94,  127,  -92,   49,
        73,   28,   26,  -26,   65,  -89,   48,  127, -128,   35,   15,  -47,
        -74,  -77,   21, -128, -128,  106,   73,  -89,   67,  116, -124,   41,
        63, -128,   61,  104,  -15,   27,   76,   58, -128,  -98, -128,   45,
        127,  127, -128,  -37,

        -26, -118,  127,   15,  -16, -105,  -21,  -40,  -32,   68,  -71, -125,
        -80,   -4,  -76,   54,   91,   20,   31,   50,  124,  114,   54,  -46,
        -85,  -75,   21,  114,   10, -107, -128,   -5,  -84,   39, -128,  -88,
        45,  127,   22,  -16,  127,  -17,   35,  113, -120,   72,   54,  127,
        -63, -128, -128,  -77,  127,  127,  121,  -71,  -82,  -71,   42,   89,
        -88,  119,   56,  -93,

        62, -101,  -51,    2,   81, -113,  -62,   24,   33,  -34,  -46,  -71,
        -128,  -42,  -15,  127,   44,  -97,  -63,  127,   37,   75,  -89, -128,
        127,   99,  127,   43, -128,   81,  127, -128,  127,  -66, -128,  -91,
        -98, -124,  127,   76,   -4,  -56,  127, -112,   -9,  127, -112,  127,
        -114,  -50,   40,  103,  127,  127,  -32,   76,   27,   46,  -36,  -75,
        77,  127,   19,  127
    };
    float X_scale[24] = {
        0.0085, 0.0061, 0.0073, 0.0079, 0.0067, 0.0074, 0.0079, 0.0046, 0.0074, 0.0077,
        0.0056, 0.0058, 0.0086, 0.0051, 0.0073, 0.0068, 0.0071, 0.0068, 0.0059, 0.0066,
        0.0067, 0.0060, 0.0065, 0.0065
    };
    int W_idx_OC[4] = {0, 3, 5, 8};
    int16_t W_idx_IC[9] = {0, 2, 3, 0, 1, 2, 0, 2, 3};
    uint8_t W_idx_X[8] = {0, 1, 2, 0, 1, 0, 2, 1};
    uint8_t W_idx_Y[8] = {0, 2, 1, 2, 0, 1, 1, 0};
    int8_t W_val[8] = {-36, 58, 16, 40, -4, -37, 45, 9};
    float W_scale[1] = {0.0164f};
    int8_t dLdO[384] = {
        -6, -36, -16, -25,  34,  -5,  -6,  10,  15,  12,  43, -43, -51,  50,
        -49, -32,  44,  22,  39, -27,  31,  53,   6,  12,  34, -10, -17, -52,
        -56,   5,  19, -31, -36, -44, -55,  22,  50,  11,  23, -34,   3, -20,
        -18,  40,  -7, -29, -54,   8, -57,  47,  26, -50,  10, -12,  19,  58,
        41, -21,  58,  -5,  -1,   1, -45,  23,

        16,  37,  15,  -4, -11,  27, -22, -39, -55,  23, -16, -48,  40,  12,
        8,   7, -31,  48,   4,   8, -24, -15,  30, -14,  -5,  -3,  64,  26,
        8,  31, -36,  44, -18, -52,  64, -36,  26,  36,  37, -51,  49,  47,
        -2, -18,  52, -24, -63,  35,  58, -19,  62,  53,   2, -10, -11,   7,
        -6, -46,  32,  23, -11,  33, -51,  10,

        18,  13,   1,   9,  55,  12,  49, -10, -29,   5,  -4,  26,  12,  24,
        34,  27,  -5,  36,  -1,  36,  44,  41, -58, -27,  44, -23,  39,  58,
        -10,  26,  43,  13,  30,  53,  14, -16, -17, -31,   9,  40,  58, -12,
        28, -45,  42,  59, -54,  49, -51, -52,  23,  -2, -34,  -7, -60,  33,
        -30,  58,  49,  50, -31,   2,  32,  41,

        -43,  20,  32, -50,  36,  14, -22,  35,  -8,   4,  13, -26, -32,  -4,
        34,  23, -31, -27, -27, -30, -39, -20, -22,  54,  13,  12, -15, -37,
        30, -46, -37,  20,  -5,  42,  45,  53,  -9, -27, -59,  22,  29,  16,
        47, -39, -25,  20,  51, -54, -29, -49, -31, -41,  28, -58,  41,  -4,
        54, -34, -36, -14, -42,  -4, -36,  36,

        26,  23,  51,  -5, -38, -44,   2,  43, -37,  -9,  42, -50, -10,  44,
        -25, -53,  56, -28, -12,  -3, -23, -33,  18,  52, -22, -48,  42,  -2,
        31,  44,  17,  12, -54,  38,  -4,   5, -24,  38,  24, -32, -22, -47,
        30, -49, -36,  28, -24,  42, -19,   0, -25,   2, -24,  12,  46, -44,
        -12,  51, -45,  26, -36,  56,  10,   0,

        -56,  55,  27, -23,  49,   5, -51, -11, -24,  -3, -29,  34, -56,  54,
        -52,  13, -43,  41, -42, -22, -39, -35,  19,  -3,  51,  -1, -26, -29,
        -20, -58,  44,  20, -49, -10, -30,  14,   5, -50,  22,   5, -25,  28,
        3, -30,  57,   7, -19, -31,  18, -16,  39,  -8, -45, -57,  -1,   9,
        16, -36, -33, -40,  53, -53,  22,  14
    };
    float dLdO_scale[6] = {0.0172f, 0.0152f, 0.0164f, 0.0171f, 0.0173f, 0.0173f};
    float dLdX[1536];
    for (int i = 0; i < 1536; i++) {
        dLdX[i] = 0.0f;
    }
    float expected_dLdX[1536] = {
        0.0630055, 0.359686, 0.167985, 0.253749, -0.334338, 0.0506311, 0.0634343, -0.0967107, -0.159064, -0.124919, -0.428964, 0.426621, 0.513312, -0.505313, 0.503516, 0.32473,
        -0.445297, -0.217289, -0.394454, 0.27989, -0.309442, -0.541303, -0.0653489, -0.12439, -0.348574, 0.100434, 0.171368, 0.52134, 0.564342, -0.0495487, -0.192, 0.312514,
        0.363298, 0.447505, 0.550512, -0.221882, -0.509213, -0.114835, -0.227602, 0.342184, -0.0271033, 0.200457, 0.17804, -0.404227, 0.0733831, 0.288822, 0.545837, -0.0748338,
        0.567731, -0.479718, -0.259269, 0.499675, -0.100387, 0.11665, -0.199482, -0.583318, -0.41222, 0.209449, -0.58195, 0.0554593, 0.00677979, -0.00476987, 0.454652, -0.23065,
        -0.181716, -0.136715, -0.0123592, -0.0951821, -0.546108, -0.115703, -0.488166, 0.0906274, 0.290198, -0.0461244, 0.0314502, -0.259481, -0.119675, -0.240722, -0.335885, -0.265372,
        0.0510654, -0.359746, 0.00616409, -0.358781, -0.434693, -0.406861, 0.581654, 0.261297, -0.441641, 0.221282, -0.382405, -0.580178, 0.100812, -0.264261, -0.426057, -0.125426,
        -0.294984, -0.52809, -0.136813, 0.164597, 0.161026, 0.309753, -0.0943198, -0.404589, -0.584405, 0.120124, -0.277032, 0.44676, -0.419529, -0.589792, 0.535377, -0.483599,
        0.512622, 0.52178, -0.225296, 0.0169358, 0.339517, 0.0757364, 0.594771, -0.330037, 0.292852, -0.577032, -0.4827, -0.494269, 0.304361, -0.0236628, -0.323181, -0.406472,
        0.157451, 0.368028, 0.15185, -0.0380259, -0.112725, 0.26855, -0.217765, -0.383781, -0.547967, 0.231347, -0.160737, -0.473619, 0.399822, 0.120798, 0.080283, 0.0664784,
        -0.315177, 0.480577, 0.0400077, 0.0810503, -0.235524, -0.154611, 0.300796, -0.132714, -0.049587, -0.0355791, 0.641517, 0.265219, 0.0778369, 0.299812, -0.36107, 0.434586,
        -0.177322, -0.51397, 0.630643, -0.363071, 0.258838, 0.361405, 0.369314, -0.510291, 0.486748, 0.466956, -0.0135462, -0.174633, 0.511321, -0.240875, -0.625423, 0.349732,
        0.573563, -0.182673, 0.614327, 0.521905, 0.0251335, -0.0930318, -0.105676, 0.0688656, -0.0567687, -0.453059, 0.317184, 0.225982, -0.114181, 0.33251, -0.501228, 0.102751,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.101948, -0.582002, -0.271814, -0.410587, 0.540987, -0.0819254, -0.102642, 0.156486, 0.257379, 0.202129, 0.694099, -0.690307, -0.830581, 0.817638, -0.81473, -0.52544,
        0.720527, 0.351592, 0.638259, -0.452884, 0.500704, 0.875872, 0.10574, 0.201274, 0.564022, -0.162511, -0.277288, -0.843572, -0.913153, 0.080174, 0.310672, -0.505674,
        -0.587846, -0.7241, -0.890773, 0.359023, 0.823948, 0.185812, 0.368279, -0.553683, 0.0438554, -0.324356, -0.288083, 0.654072, -0.11874, -0.467339, -0.883209, 0.121087,
        -0.918636, 0.776224, 0.419519, -0.808515, 0.162435, -0.188749, 0.322779, 0.943857, 0.667006, -0.338905, 0.941643, -0.0897378, -0.0109703, 0.00771805, -0.735665, 0.373211,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.217234, 0.163437, 0.0147748, 0.113786, 0.652848, 0.138318, 0.583581, -0.108341, -0.346919, 0.0551397, -0.0375974, 0.310198, 0.143066, 0.287772, 0.401536, 0.31724,
        -0.0610464, 0.430061, -0.0073689, 0.428906, 0.519656, 0.486384, -0.695341, -0.312369, 0.527962, -0.264533, 0.457148, 0.693577, -0.120516, 0.315912, 0.509333, 0.149941,
        0.35264, 0.631308, 0.163553, -0.196768, -0.192499, -0.370296, 0.112755, 0.483668, 0.69863, -0.143603, 0.331179, -0.534082, 0.501528, 0.705069, -0.64002, 0.578121,
        -0.612817, -0.623765, 0.269331, -0.020246, -0.405878, -0.0905395, -0.711023, 0.394545, -0.350092, 0.689816, 0.577047, 0.590877, -0.363849, 0.0282879, 0.386348, 0.485919,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0.0255717, -0.00610609, -0.0125945, 0.0256315, 0.136352, -0.000809473, 0.133767, 0.0182469, -0.0107244, -0.012945, 0.00913045, 0.107446, -0.0132324, 0.0427895, 0.0686696, 0.0539439,
        0.0203284, 0.033475, -0.00547283, 0.0738283, 0.123341, 0.108758, -0.163582, -0.0462853, 0.106047, -0.0469977, 0.0223131, 0.105762, -0.0309622, 0.0299934, 0.134115, -0.0154475,
        0.0854759, 0.17298, -0.0327538, -0.00077431, -0.0631157, -0.107549, -0.0159332, 0.144359, 0.0842316, -0.0748963, 0.0647377, -0.0844469, 0.0440262, 0.159358, -0.058935, 0.0750903,
        -0.175494, -0.100789, -0.0108591, -0.0568758, -0.0802059, -0.00787434, -0.125303, 0.0684915, -0.0612152, 0.177988, 0.0781901, 0.0900982, -0.0580168, -0.0283561, 0.124819, 0.0825323,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        -0.0290192, -0.165665, -0.0773711, -0.116872, 0.15399, -0.0233198, -0.0292167, 0.0445432, 0.0732622, 0.0575354, 0.197573, -0.196494, -0.236422, 0.232738, -0.23191, -0.149565,
        0.205096, 0.10008, 0.181679, -0.128912, 0.142524, 0.249314, 0.0300985, 0.0572919, 0.160547, -0.0462582, -0.0789292, -0.24012, -0.259926, 0.0228213, 0.0884319, -0.143938,
        -0.167329, -0.206113, -0.253556, 0.102195, 0.234534, 0.0528909, 0.10483, -0.157604, 0.0124833, -0.0923271, -0.0820021, 0.18618, -0.033799, -0.133026, -0.251403, 0.0344671,
        -0.261487, 0.22095, 0.119415, -0.230141, 0.0462366, -0.0537267, 0.091878, 0.268666, 0.189861, -0.0964684, 0.268036, -0.0255436, -0.00312265, 0.00219692, -0.209405, 0.106233,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0
    };
    float dLdW_val[8] = {0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f, 0.0f};
    float expected_dLdW_val[8] = {
        2.86988, 2.6798, 2.35642, -0.574233, -2.91686, 2.39239, -4.51477, -1.17145
    };

    sparse::quantized_grouped_sparse_conv2d_vectorized_parallel_backward_stride_2(
        B, IC, OC, M, N, K, 8, 0, X, X_scale, 64, W_idx_OC, W_idx_IC, W_idx_X,
        W_idx_Y, W_val, W_scale, 64, dLdO, dLdO_scale, 64, dLdX, dLdW_val
    );

    for (int i = 0; i < 1536; i++) {
        ASSERT_THAT(dLdX[i], testing::FloatNear(expected_dLdX[i], 0.025f));
    }

    for (int i = 0; i < 8; i++) {
        ASSERT_THAT(dLdW_val[i], testing::FloatNear(expected_dLdW_val[i], std::abs(expected_dLdW_val[i]) * 0.35));
    }
}
